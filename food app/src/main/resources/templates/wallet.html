<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>My Wallet • SpiceJar</title>

    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root{
            --green:#218838;
            --accent:#b7410e;
            --muted:#6b7280;
            --line:#e6ece7;
            --text-dark:#111827;
            --bg:#f6fbf6;
            --ring:rgba(15,23,42,.08);
        }

        *{ box-sizing:border-box; }

        body{
            margin:0;
            background:radial-gradient(circle at top left,#e0f5e5 0,#f6fbf6 40%,#f0f8f0 100%);
            color:var(--text-dark);
            font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;
        }

        .card{
            border-radius:16px;
            border:1px solid #e5e7eb;
            background:#fff;
            box-shadow:0 12px 30px var(--ring);
        }

        /* Navbar */
        .navbar{
            background:#fff;
            padding:6px 6%;
            box-shadow:0 2px 6px rgba(0,0,0,.05);
            display:flex;
            justify-content:space-between;
            align-items:center;
            position:sticky;
            top:0;
            z-index:1000;
            height:60px;
            gap:14px;
        }

        .brand-logo{
            display:flex;
            align-items:center;
            gap:8px;
            text-decoration:none;
            color:var(--green);
            font-weight:800;
            font-size:20px;
            letter-spacing:.02em;
            white-space:nowrap;
        }

        .brand-logo video{
            width:36px;
            height:36px;
            border-radius:8px;
            object-fit:cover;
            box-shadow:0 4px 12px rgba(0,0,0,.12);
        }

        .nav-links{
            display:flex;
            align-items:center;
            gap:18px;
            flex-wrap:wrap;
        }

        .nav-links a{
            text-decoration:none;
            color:#333;
            font-weight:500;
            font-size:15px;
        }
        .nav-links a:hover{ color:var(--green); }

        /* Cart */
        .cart-icon-container{
            position:relative;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            color:#333;
        }

        .cart-count-badge{
            position:absolute;
            top:-8px;
            right:-10px;
            padding:2px 6px;
            border-radius:9999px;
            background:#ef4444;
            color:#fff;
            font-size:11px;
            font-weight:700;
            line-height:1;
            min-width:18px;
            text-align:center;
            box-shadow:0 0 0 2px #fff;
        }

        /* Dropdown (STABLE) */
        .dropdown{
            position:relative;
            display:inline-flex;
            align-items:center;
        }

        .dropdown-toggle{
            display:inline-flex;
            align-items:center;
            gap:8px;
            background:transparent;
            border:0;
            cursor:pointer;
            font-weight:700;
            color:#111827;
            padding:6px 10px;
            border-radius:999px;
            line-height:1;
            white-space:nowrap;
            transition:background .15s ease, box-shadow .15s ease;
        }

        .dropdown-toggle:hover{
            background:#f3f4f6;
            box-shadow:0 0 0 1px rgba(148,163,184,0.3);
        }

        .dropdown-menu{
            display:none;
            position:absolute;
            right:0;
            top:calc(100% + 10px);
            background:#fff;
            box-shadow:0 10px 28px rgba(15,23,42,.16);
            border-radius:12px;
            overflow:hidden;
            min-width:220px;
            border:1px solid #e5e7eb;
            z-index:2000;
        }

        /* hover-bridge */
        .dropdown::after{
            content:"";
            position:absolute;
            right:0;
            top:100%;
            width:240px;
            height:12px;
            background:transparent;
        }

        .dropdown.open .dropdown-menu{
            display:block;
        }

        .dropdown-menu a,
        .dropdown-menu span{
            display:block;
            padding:10px 14px;
            text-decoration:none;
            color:#111827;
            white-space:nowrap;
            font-size:14px;
            font-weight:500;
        }

        .dropdown-menu a:hover{ background:#f7faf7; }

        .divider{
            height:1px;
            background:#e5e7eb;
            margin:6px 0;
        }

        .chip{
            border-radius:999px;
            border:1px solid #e5e7eb;
            background:#fff;
        }
    </style>
</head>

<body class="min-h-screen text-slate-900">

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>

        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>

        <a th:href="@{/contact}">Contact Us</a>

        <!-- Account (stable dropdown) -->
        <div class="dropdown" id="accountDropdown">
            <button class="dropdown-toggle" type="button" id="accountBtn" aria-haspopup="menu" aria-expanded="false">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
                <i class="fa-solid fa-chevron-down" style="font-size:12px;opacity:.7;"></i>
            </button>

            <div class="dropdown-menu" role="menu" aria-label="Account menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>

                <span th:if="${session.USER != null}">
          Welcome, <strong th:text="${session.USER.firstName}">User</strong>
        </span>

                <a th:if="${session.USER != null}" th:href="@{/account}">
                    <i class="fa-solid fa-user"></i> Your Account
                </a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">
                    <i class="fa-solid fa-box"></i> My Orders
                </a>
                <a th:if="${session.USER != null}" th:href="@{/account/wallet}">
                    <i class="fa-solid fa-coins"></i> Wallet
                </a>

                <div class="divider" th:if="${session.USER != null}"></div>

                <a th:if="${session.USER != null}" th:href="@{/logout}">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>
    </div>
</nav>

<main class="max-w-6xl mx-auto px-5 py-8 space-y-6">

    <!-- Header -->
    <section class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight">Loyalty Wallet</h1>
            <p class="text-slate-600 mt-1">
                Earn points on every order and redeem them as cash discounts.
            </p>
        </div>

        <a th:href="@{/checkout}"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">
            <i class="fa-solid fa-bag-shopping"></i>
            Go to Checkout
        </a>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-5">
            <div class="flex items-center justify-between">
                <div class="text-slate-600 text-sm">Current Points</div>
                <span class="chip px-3 py-1 text-xs text-emerald-700 border-emerald-200 bg-emerald-50">
          Wallet
        </span>
            </div>

            <div class="mt-2 text-4xl font-extrabold text-emerald-700"
                 th:text="${walletPoints != null ? walletPoints : 0}">
                0
            </div>

            <div class="mt-1 text-sm text-slate-500">
                Value:
                <span class="font-semibold">
          $<span th:text="${walletPoints != null ? walletPoints : 0}">0</span>
        </span>
            </div>
        </div>

        <div class="card p-5">
            <div class="text-slate-600 text-sm">Earn Rule</div>
            <div class="mt-2 text-xl font-bold">
                $10 spent → 1 point
            </div>
            <div class="mt-1 text-sm text-slate-500">
                Points are credited after payment success.
            </div>
        </div>

        <div class="card p-5">
            <div class="text-slate-600 text-sm">Redeem Rule</div>
            <div class="mt-2 text-xl font-bold">
                50 points = $1 discount
            </div>

            <div class="mt-1 text-sm text-slate-500">
                Redeem instantly at checkout.
            </div>
        </div>
    </section>

    <!-- Messages -->
    <div th:if="${msg}" class="card p-4 border-emerald-200 bg-emerald-50 text-emerald-800 font-semibold"
         th:text="${msg}"></div>

    <div th:if="${error}" class="card p-4 border-rose-200 bg-rose-50 text-rose-800 font-semibold"
         th:text="${error}"></div>

    <!-- Recent Activity -->
    <section class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left text-emerald-600"></i>
                Recent Activity
            </h2>
            <span class="text-sm text-slate-500">Last 10 entries</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead>
                <tr class="text-slate-600">
                    <th class="py-2 pr-4 text-left border-b">Date</th>
                    <th class="py-2 pr-4 text-left border-b">Type</th>
                    <th class="py-2 pr-4 text-left border-b">Order</th>
                    <th class="py-2 pr-4 text-left border-b">Note</th>
                    <th class="py-2 text-right border-b">Points</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="tx : ${ledger}" class="border-b">
                    <td class="py-3 pr-4"
                        th:text="${#temporals.format(tx.createdAt,'MMM d, yyyy h:mm a')}"></td>

                    <td class="py-3 pr-4">
            <span class="chip px-2 py-1 text-xs"
                  th:classappend="${tx.type.name() == 'EARN'} ?
                    ' border-emerald-200 bg-emerald-50 text-emerald-800' :
                    ' border-amber-200 bg-amber-50 text-amber-800'"
                  th:text="${tx.type}">
            </span>
                    </td>

                    <td class="py-3 pr-4">
            <span th:if="${tx.orderId != null}">
              #<a th:href="@{/orders/{id}(id=${tx.orderId})}"
                  class="text-emerald-700 hover:underline"
                  th:text="${tx.orderId}"></a>
            </span>
                        <span th:if="${tx.orderId == null}" class="text-slate-400">—</span>
                    </td>

                    <td class="py-3 pr-4 text-slate-600" th:text="${tx.note}"></td>

                    <td class="py-3 text-right font-extrabold"
                        th:classappend="${tx.points >= 0} ? ' text-emerald-700' : ' text-rose-600'"
                        th:text="${tx.points >= 0 ? '+' + tx.points : tx.points}">
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(ledger)}">
                    <td colspan="5" class="py-8 text-center text-slate-500">
                        No wallet activity yet. Place your first order to start earning!
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Tips -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card p-5">
            <h3 class="font-bold mb-2">
                <i class="fa-solid fa-lightbulb text-amber-500"></i>
                Tips
            </h3>
            <ul class="text-sm text-slate-600 list-disc pl-5 space-y-1">
                <li>Use points on larger orders to save more.</li>
                <li>Points apply before tax and shipping.</li>
                <li>Refunds may reverse earned points.</li>
            </ul>
        </div>

        <div class="card p-5">
            <h3 class="font-bold mb-2">
                <i class="fa-solid fa-headset text-emerald-600"></i>
                Need Help?
            </h3>
            <p class="text-sm text-slate-600">
                If something looks wrong, contact support with your order number.
            </p>
            <a th:href="@{/contact}"
               class="inline-flex items-center gap-2 mt-3 px-4 py-2 rounded-xl border hover:bg-slate-50">
                Contact Support
            </a>
        </div>
    </section>

</main>

<footer class="py-10 text-center text-sm text-slate-500">
    © <span th:text="${#calendars.format(#calendars.createNow(),'yyyy')}"></span> SpiceJar
</footer>

<!-- Click-toggle dropdown JS (stable, no dancing) -->
<script>
    (function () {
        const dd = document.getElementById('accountDropdown');
        const btn = document.getElementById('accountBtn');
        if (!dd || !btn) return;

        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dd.classList.toggle('open');
            btn.setAttribute('aria-expanded', String(isOpen));
        });

        document.addEventListener('click', () => {
            dd.classList.remove('open');
            btn.setAttribute('aria-expanded', 'false');
        });

        dd.addEventListener('click', (e) => e.stopPropagation());
    })();
</script>

</body>
</html>
