<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Choose Payment • The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF (used by fetch POSTs) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root {
            --green:#218838;
            --light-green:#eef8f0;
            --muted:#6b7280;
            --line:#e6ece7;
            --text-dark:#1f2937;
            --bg:#f6fbf6;
        }

        * { box-sizing:border-box; }

        body{
            font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;
            background:radial-gradient(circle at top left,#e0f5e5 0,#f6fbf6 40%,#f0f8f0 100%);
            margin:0;
            color:var(--text-dark);
        }

        .navbar{
            background:#fff;
            padding:6px 6%;
            box-shadow:0 2px 6px rgba(0,0,0,.05);
            display:flex;
            justify-content:space-between;
            align-items:center;
            position:sticky;
            top:0;
            z-index:1000;
            height:60px;
        }
        .brand-logo{
            display:flex;
            align-items:center;
            gap:8px;
            text-decoration:none;
            color:var(--green);
            font-weight:700;
            font-size:20px;
        }
        .brand-logo video{
            width:36px;
            height:auto;
            border-radius:4px;
        }
        .nav-links{
            display:flex;
            align-items:center;
            gap:18px;
        }
        .nav-links a{
            text-decoration:none;
            color:#333;
            font-weight:500;
            font-size:15px;
        }
        .nav-links a:hover{ color:var(--green); }

        .dropdown{ position:relative; }
        .dropdown-toggle{
            background:none;
            border:none;
            cursor:pointer;
            font-size:15px;
            color:#333;
            display:flex;
            align-items:center;
            gap:6px;
        }
        .dropdown-menu{
            display:none;
            position:absolute;
            right:0;
            top:100%;
            background:#fff;
            box-shadow:0 4px 10px rgba(0,0,0,.1);
            border-radius:6px;
            overflow:hidden;
            min-width:180px;
        }
        .dropdown:hover .dropdown-menu{ display:block; }
        .dropdown-menu a,
        .dropdown-menu span{
            display:block;
            padding:10px 16px;
            text-decoration:none;
            color:#333;
            white-space:nowrap;
        }
        .dropdown-menu a:hover{ background:#f4f4f4; }

        .cart-icon-container{
            position:relative;
            display:inline-block;
        }
        .cart-count-badge{
            position:absolute;
            top:-8px;
            right:-10px;
            padding:2px 6px;
            border-radius:9999px;
            background:#ef4444;
            color:#fff;
            font-size:11px;
            font-weight:bold;
            line-height:1;
        }

        main{
            max-width:1100px;
            margin:32px auto;
            padding:0 6%;
        }
        h1{
            margin:0 0 4px;
            color:var(--green);
            font-size:26px;
        }
        .subtitle{
            color:#64748b;
            margin:4px 0 24px;
            font-size:14px;
        }

        .grid{
            display:grid;
            grid-template-columns:2fr 1fr;
            gap:24px;
        }
        @media(max-width:980px){
            .grid{ grid-template-columns:1fr; }
        }

        .card{
            background:#fff;
            border:1px solid var(--line);
            border-radius:14px;
            box-shadow:0 10px 30px rgba(0,0,0,.06);
            padding:24px;
            margin-bottom:24px;
        }
        .payment-area .card{ margin-bottom:0; }

        .section-title{
            font-size:22px;
            font-weight:900;
            color:var(--text-dark);
            margin:0 0 12px;
        }
        .badge-secure{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:6px 12px;
            background:#f0fdf4;
            color:#065f46;
            border-radius:8px;
            font-size:13px;
            font-weight:500;
            margin-bottom:16px;
        }

        .option{
            display:flex;
            align-items:center;
            justify-content:space-between;
            border:1px solid var(--line);
            border-radius:12px;
            padding:16px;
            margin-top:12px;
            transition:all .2s ease;
            cursor:pointer;
        }
        .option:first-of-type{ margin-top:0; }
        .option:hover{
            border-color:var(--green);
            box-shadow:0 4px 8px rgba(0,0,0,.05);
        }
        .left{
            display:flex;
            gap:12px;
            align-items:center;
        }
        .icon{
            width:48px;
            height:48px;
            display:grid;
            place-items:center;
            border-radius:12px;
            background:var(--light-green);
            color:var(--green);
            font-size:22px;
        }

        .btn{
            border:none;
            cursor:pointer;
            border-radius:10px;
            padding:10px 16px;
            font-weight:700;
            font-size:14px;
            transition:background .2s ease, box-shadow .2s ease, transform .05s ease;
        }
        .btn:hover{
            transform:translateY(-1px);
        }
        .btn.primary{
            background:var(--green);
            color:#fff;
        }
        .btn.primary:hover{
            background:#1a6f30;
            box-shadow:0 4px 10px rgba(34,197,94,.25);
        }
        .btn.ghost{
            background:#fff;
            border:1px solid #dcdcdc;
            color:var(--text-dark);
        }
        .btn.ghost:hover{
            background:#f4f4f4;
        }

        .wallets{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin:8px 0 18px;
        }
        .wallet{
            flex:1 1 180px;
            display:flex;
            gap:10px;
            align-items:center;
            justify-content:center;
            border:1px dashed #d7eadb;
            padding:10px;
            border-radius:12px;
            background:#fafdfb;
            cursor:pointer;
            font-size:14px;
        }
        .wallet img{ height:20px; }
        .wallet strong{ font-weight:700; }
        .wallet:hover{ background:#f3fbf6; }

        .hr{
            height:1px;
            background:var(--line);
            border:none;
            margin:16px 0;
        }

        h3.summary-title{
            margin:0 0 16px;
            border-bottom:1px solid var(--line);
            padding-bottom:8px;
            font-size:20px;
        }

        .summary-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }

        .btn-edit{
            display:inline-flex;
            align-items:center;
            gap:4px;
            padding:4px 10px;
            border-radius:8px;
            font-size:13px;
            font-weight:600;
            text-decoration:none;
            color:var(--green);
            background:var(--light-green);
            border:1px solid #d7eadb;
            transition:background .2s ease;
        }
        .btn-edit:hover{ background:#d7eadb; }

        .row{
            display:flex;
            justify-content:space-between;
            margin:6px 0;
            font-size:14px;
        }
        .price-details .row{ margin:8px 0; }

        .row span:first-child{ color:var(--muted); }
        .row.total{
            font-size:17px;
            font-weight:900;
            padding-top:8px;
            color:#065f46;
        }

        .toast{
            position:fixed;
            left:50%;
            transform:translateX(-50%);
            bottom:24px;
            background:#1a6f30;
            color:#fff;
            padding:12px 18px;
            border-radius:10px;
            z-index:9999;
            box-shadow:0 4px 12px rgba(0,0,0,.15);
            font-size:14px;
        }

        .gift-card-box{
            border:1px dashed #d7eadb;
            border-radius:12px;
            padding:12px 10px;
            margin:12px 0 16px;
            background:#f9fdf9;
        }
        .gift-card-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:8px;
        }
        .gift-card-header span{
            font-size:13px;
            color:var(--muted);
        }
        .gift-row{
            display:flex;
            gap:8px;
            align-items:stretch;
            margin-top:6px;
        }
        .gift-row input{
            flex:1;
            padding:9px 10px;
            border-radius:8px;
            border:1px solid #d1d5db;
            font-size:14px;
        }
        .gift-row button{ white-space:nowrap; }
        .gift-hint{
            font-size:12px;
            color:var(--muted);
            margin-top:4px;
        }

        /* ===== UPDATED Loyalty Wallet styles + remove button ===== */
        .wallet-box{
            border:1px dashed #d7eadb;
            border-radius:12px;
            padding:12px 10px;
            margin:12px 0 16px;
            background:#f9fdf9;
        }
        .wallet-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:8px;
        }
        .wallet-header span{
            font-size:13px;
            color:var(--muted);
        }
        .wallet-row{
            display:flex;
            gap:8px;
            align-items:stretch;
            margin-top:6px;
        }
        .wallet-row input{
            flex:1;
            padding:9px 10px;
            border-radius:8px;
            border:1px solid #d1d5db;
            font-size:14px;
        }
        .wallet-hint{
            font-size:12px;
            color:var(--muted);
            margin-top:4px;
        }

        .card-inline{
            border:1px solid var(--line);
            border-radius:12px;
            padding:14px 14px 12px;
            background:#fafdfb;
        }
        .card-inline-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
            font-weight:700;
            font-size:14px;
        }
        .card-inline-close{
            border:none;
            background:transparent;
            cursor:pointer;
            color:#9ca3af;
            font-size:16px;
        }
        .field{
            margin-bottom:10px;
        }
        .field label{
            display:block;
            font-size:12px;
            font-weight:600;
            color:#6b7280;
            margin-bottom:4px;
        }
        .field input{
            width:100%;
            padding:9px 10px;
            border-radius:8px;
            border:1px solid #d1d5db;
            font-size:14px;
        }
        .field input:focus{
            outline:none;
            border-color:var(--green);
            box-shadow:0 0 0 2px rgba(34,197,94,.15);
        }
        .field-inline{
            display:flex;
            gap:10px;
        }
        @media(max-width:600px){
            .field-inline{ flex-direction:column; }
        }
        .card-input{
            padding:10px 10px;
            border-radius:8px;
            border:1px solid #d1d5db;
            background:#fff;
        }
        .card-brands{
            margin-top:6px;
            font-size:20px;
            color:#9ca3af;
            display:flex;
            gap:4px;
        }
        .card-inline-footer{
            margin-top:10px;
            display:flex;
            justify-content:flex-end;
            gap:8px;
        }
        .card-hint{
            margin:6px 0 0;
            font-size:11px;
            color:#6b7280;
        }
    </style>
</head>

<body>

<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <div class="dropdown">
            <button class="dropdown-toggle" type="button">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>

                <span th:if="${session.USER != null}"
                      style="display:block;padding:10px 16px;font-weight:600;border-bottom:1px solid var(--line);">
                    Welcome, <strong th:text="${session.USER.firstName}">User</strong>
                </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}" style="color:#ef4444;font-weight:500;">Logout</a>
            </div>
        </div>
    </div>
</nav>

<main>
    <h1>Choose your payment method</h1>
    <p class="subtitle">Select a secure option to complete your order and guarantee your delivery.</p>

    <section class="grid">
        <div class="card payment-area">
            <h2 class="section-title">Payment Selection</h2>
            <div class="badge-secure">
                <i class="fa-solid fa-lock"></i>
                <span>All payments are encrypted &amp; processed securely.</span>
            </div>

            <div class="wallets" role="group" aria-label="Express wallets">
                <button class="wallet" id="btn-apple" type="button">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple logo" aria-hidden="true">
                    <strong>Pay with Apple&nbsp;Pay</strong>
                </button>
                <button class="wallet" id="btn-google" type="button">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg" alt="Google logo" aria-hidden="true">
                    <strong>Pay with Google&nbsp;Pay</strong>
                </button>
            </div>

            <hr class="hr">

            <div class="option" id="option-card">
                <div class="left">
                    <div class="icon"><i class="fa-solid fa-credit-card"></i></div>
                    <div>
                        <div style="font-weight:800;">Credit / Debit Card</div>
                        <div style="color:var(--muted);font-size:14px;">Pay securely with VISA, Mastercard, AmEx and more.</div>
                    </div>
                </div>
                <button id="btn-card" class="btn primary" type="button">Enter card details</button>
            </div>

            <div id="card-form-wrapper" class="card-inline" style="display:none;margin-top:14px;">
                <form id="card-form">
                    <div class="card-inline-header">
                        <span>Card details</span>
                        <button type="button" id="card-close" class="card-inline-close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="field">
                        <label for="cardholder-name">Name on card</label>
                        <input id="cardholder-name" type="text" placeholder="ALTHAF HUSSAIN SHAIK"/>
                    </div>

                    <div class="field">
                        <label>Card information</label>
                        <div id="card-element" class="card-input"></div>
                        <div class="card-brands">
                            <i class="fa-brands fa-cc-visa"></i>
                            <i class="fa-brands fa-cc-mastercard"></i>
                            <i class="fa-brands fa-cc-amex"></i>
                            <i class="fa-brands fa-cc-discover"></i>
                        </div>
                    </div>

                    <div class="field-inline">
                        <div class="field">
                            <label for="billing-email">Billing email</label>
                            <input id="billing-email" type="email" th:value="${order.email}" placeholder="you@example.com"/>
                        </div>
                        <div class="field">
                            <label for="billing-zip">ZIP / Postal code</label>
                            <input id="billing-zip" type="text" th:value="${order.zip}" placeholder="23059"/>
                        </div>
                    </div>

                    <div class="card-inline-footer">
                        <button type="button" class="btn ghost" id="card-cancel">Cancel</button>
                        <button type="submit" class="btn primary" id="card-submit">
                            Pay
                            <span id="card-pay-amount">
                                $<span id="card-pay-amount-inner"
                                       th:text="${#numbers.formatDecimal((order.remainingToPay != null ? order.remainingToPay : order.grandTotal),1,'COMMA',2,'POINT')}">0.00</span>
                            </span>
                        </button>
                    </div>

                    <p class="card-hint">Your card will be charged securely via Stripe. We don’t store your card details.</p>
                </form>
            </div>

            <div class="option" id="option-paypal" style="margin-top:18px;">
                <div class="left">
                    <div class="icon" style="background:#e8f4fd;color:#003087;">
                        <i class="fa-brands fa-paypal"></i>
                    </div>
                    <div>
                        <div style="font-weight:800;">PayPal</div>
                        <div style="color:var(--muted);font-size:14px;">You’ll be redirected to PayPal to approve.</div>
                    </div>
                </div>
                <button id="btn-paypal" class="btn ghost" type="button">Continue with PayPal</button>
            </div>
        </div>

        <aside class="card">
            <h3 class="summary-title">Order Summary</h3>

            <div class="summary-header">
                <h4 style="margin:0;font-size:16px;">Shipping Address</h4>
                <a th:href="@{/shipping/edit}" class="btn-edit">
                    <i class="fas fa-pencil-alt"></i> Edit
                </a>
            </div>

            <div class="address-details">
                <div class="row"><span>Name</span><span th:text="${order.customerName}">—</span></div>
                <div class="row"><span>Street</span><span th:text="${order.street}">—</span></div>
                <div class="row"><span>City, State</span><span th:text="${order.city + ', ' + order.state}">—</span></div>
                <div class="row"><span>ZIP, Country</span><span th:text="${order.zip + ', ' + order.country}">—</span></div>
                <div class="row"><span>Phone</span><span th:text="${order.phone}">—</span></div>
                <div class="row"><span>Email</span><span th:text="${order.email}">—</span></div>
            </div>

            <hr class="hr">

            <!-- ===================== GIFT CARD (existing) ===================== -->
            <div class="gift-card-box">
                <div class="gift-card-header">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <i class="fa-solid fa-gift" style="color:#b56a00;"></i>
                        <strong>Use your SpiceJar gift balance</strong>
                    </div>
                    <span>
                        Balance:
                        $<span id="gc-balance" th:text="${#numbers.formatDecimal(giftBalance != null ? giftBalance : 0,1,'COMMA',2,'POINT')}">0.00</span>
                    </span>
                </div>

                <div class="gift-row">
                    <input id="gc-amount" type="number" step="0.01" min="0" placeholder="Enter amount to apply">
                    <button id="gc-apply" type="button" class="btn primary">Apply</button>
                </div>
                <div class="gift-hint" id="gc-msg">You can use any amount up to your gift balance and order total.</div>
            </div>

            <!-- ===================== LOYALTY WALLET (UPDATED) ===================== -->
            <div class="wallet-box">
                <div class="wallet-header">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <i class="fa-solid fa-star" style="color:#f59e0b;"></i>
                        <strong>Use Loyalty Wallet</strong>
                    </div>
                    <span>
                        Points:
                        <span id="wallet-points-balance"
                              th:text="${walletPoints != null ? walletPoints : 0}">0</span>
                    </span>
                </div>

                <!-- ✅ rule shown + enforce 50-step in input -->
                <div class="wallet-hint" style="margin-top:-2px;">
                    Redeem in steps of <strong>50 points</strong> (50 points = $1.00).
                </div>

                <div class="wallet-row">
                    <input id="wallet-points"
                           type="number"
                           min="50"
                           step="50"
                           placeholder="Enter points (50 = $1)">
                    <button id="wallet-apply" type="button" class="btn primary">Apply</button>
                    <button id="wallet-remove" type="button" class="btn ghost" style="display:none">Remove</button>
                </div>

                <div class="wallet-hint" id="wallet-msg">
                    Redeem points to reduce your remaining payable amount.
                </div>
            </div>

            <h4 style="margin:8px 0 8px;font-size:16px;">Price Details</h4>

            <div class="price-details">
                <div class="row"><span>Subtotal</span>
                    <span th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}">$0.00</span>
                </div>

                <!-- Discount row: updateable via JS -->
                <div class="row"><span>Discount</span>
                    <span>− $<span id="order-discount"
                                   th:text="${#numbers.formatDecimal(order.discount,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>

                <div class="row"><span>Tax (8%)</span>
                    <span th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}">$0.00</span>
                </div>

                <hr class="hr">

                <div class="row total"><span>Order Total</span>
                    <span th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span>
                </div>

                <div class="row"><span>Gift card applied</span>
                    <span>− $<span id="gc-applied" th:text="${#numbers.formatDecimal(order.giftApplied != null ? order.giftApplied : 0,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>

                <!-- wallet applied row -->
                <div class="row"><span>Wallet discount applied</span>
                    <span>− $<span id="wallet-applied">0.00</span></span>
                </div>
            </div>

            <hr class="hr">

            <div class="row total">
                <span>Amount to pay online</span>
                <span>$<span id="order-total"
                             th:text="${#numbers.formatDecimal((order.remainingToPay != null ? order.remainingToPay : order.grandTotal),1,'COMMA',2,'POINT')}">0.00</span></span>
            </div>

            <p style="font-size:12px;color:#6b7280;margin-top:6px;">
                We’ll first use your gift card balance. Any remaining amount will be charged via the payment method you choose above.
            </p>
        </aside>
    </section>
</main>

<script src="https://js.stripe.com/v3/"></script>

<script th:inline="javascript">
    const ORDER_ID   = /*[[${order.id}]]*/ 0;
    const STRIPE_KEY = /*[[${@environment.getProperty('stripe.publishable.key')}]]*/ '';

    const CSRF        = document.querySelector('meta[name="_csrf"]')?.content || '';
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
    const withCsrf    = (h = {}) => ({ ...h, [CSRF_HEADER]: CSRF, 'Content-Type': 'application/json' });

    function toast(msg, ok = true){
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.background = ok ? '#218838' : '#b00020';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }

    // ---------- Gift card apply ----------
    const gcInput    = document.getElementById('gc-amount');
    const gcApply    = document.getElementById('gc-apply');
    const gcMsg      = document.getElementById('gc-msg');
    const gcBalance  = document.getElementById('gc-balance');
    const gcApplied  = document.getElementById('gc-applied');
    const orderTotal = document.getElementById('order-total');

    function updateCardPayAmount(remaining) {
        const inner = document.getElementById('card-pay-amount-inner');
        if (!inner) return;
        inner.textContent = Number(remaining || 0).toFixed(2);
    }

    async function applyGift(){
        if (!gcInput) return;
        const raw = (gcInput.value || '').trim();
        const amount = parseFloat(raw);

        if (isNaN(amount) || amount <= 0){
            gcMsg.textContent = 'Please enter a valid amount.';
            gcMsg.style.color = '#b91c1c';
            return;
        }

        gcApply.disabled = true;
        const oldText = gcApply.textContent;
        gcApply.textContent = 'Applying…';

        try{
            const res = await fetch('/payment/gift/apply', {
                method:'POST',
                headers: withCsrf(),
                body: JSON.stringify({ orderId: ORDER_ID, amount: Number(gcInput.value || 0) })
            });

            const data = await res.json();

            if (!res.ok || data.status !== 'success'){
                gcMsg.textContent = data.message || 'Unable to apply gift balance.';
                gcMsg.style.color = '#b91c1c';
                toast('Gift card not applied', false);
            } else {
                const applied   = parseFloat(data.applied ?? 0);
                const remaining = parseFloat(data.remainingToPay ?? 0);
                const left      = parseFloat(data.giftBalanceLeft ?? 0);

                if (gcApplied && !isNaN(applied)) gcApplied.textContent = applied.toFixed(2);
                if (orderTotal && !isNaN(remaining)) orderTotal.textContent = remaining.toFixed(2);
                if (gcBalance && !isNaN(left)) gcBalance.textContent = left.toFixed(2);

                if (!isNaN(remaining)) updateCardPayAmount(remaining);

                gcMsg.textContent = data.message || ('Gift balance applied. Remaining to pay online: $' + remaining.toFixed(2));
                gcMsg.style.color = '#166534';
                toast('Gift card applied', true);
                gcInput.value = '';
            }
        } catch(e){
            console.error(e);
            gcMsg.textContent = 'Something went wrong. Please try again.';
            gcMsg.style.color = '#b91c1c';
            toast('Error applying gift card', false);
        } finally {
            gcApply.disabled = false;
            gcApply.textContent = oldText;
        }
    }

    gcApply?.addEventListener('click', applyGift);
    gcInput?.addEventListener('keydown', e => {
        if (e.key === 'Enter'){ e.preventDefault(); applyGift(); }
    });

    // ============================
    //  UPDATED: LOYALTY WALLET APPLY
    //  Rule: 50 points = $1
    //  Enforce: min 50, step 50, clamp to wallet balance
    //  Also add Remove button to reverse UI state
    // ============================
    const walletPtsInput   = document.getElementById('wallet-points');
    const walletApplyBtn   = document.getElementById('wallet-apply');
    const walletRemoveBtn  = document.getElementById('wallet-remove');
    const walletMsg        = document.getElementById('wallet-msg');
    const walletBalanceEl  = document.getElementById('wallet-points-balance');
    const walletAppliedEl  = document.getElementById('wallet-applied');
    const orderDiscountEl  = document.getElementById('order-discount');

    function clampToStep50(n){
        n = Number(n || 0);
        if (!Number.isFinite(n)) return 0;
        return Math.floor(n / 50) * 50;
    }

    function currentWalletBalance(){
        return parseInt(walletBalanceEl?.textContent || '0', 10) || 0;
    }

    async function applyWalletPoints(){
        const raw = (walletPtsInput?.value || '').trim();
        let pointsUsed = parseInt(raw, 10);

        const maxBal = currentWalletBalance();

        if (!pointsUsed || pointsUsed <= 0){
            walletMsg.textContent = 'Please enter points.';
            walletMsg.style.color = '#b91c1c';
            return;
        }

        // normalize to multiples of 50
        pointsUsed = clampToStep50(pointsUsed);

        if (pointsUsed < 50){
            walletMsg.textContent = 'Minimum redeem is 50 points ($1).';
            walletMsg.style.color = '#b91c1c';
            walletPtsInput.value = '50';
            return;
        }

        if (pointsUsed > maxBal){
            pointsUsed = clampToStep50(maxBal);
        }

        if (pointsUsed < 50){
            walletMsg.textContent = 'Not enough points (need at least 50).';
            walletMsg.style.color = '#b91c1c';
            return;
        }

        // reflect normalized value in input
        walletPtsInput.value = String(pointsUsed);

        walletApplyBtn.disabled = true;
        const oldText = walletApplyBtn.textContent;
        walletApplyBtn.textContent = 'Applying…';

        try{
            const res = await fetch('/payment/loyalty/apply', {
                method:'POST',
                headers: withCsrf(),
                body: JSON.stringify({ orderId: ORDER_ID, pointsUsed })
            });
            const data = await res.json();

            if (!res.ok || data.status !== 'success'){
                walletMsg.textContent = data.message || 'Unable to apply wallet points.';
                walletMsg.style.color = '#b91c1c';
                toast('Wallet not applied', false);
                return;
            }

            const walletDiscountApplied = Number(data.walletDiscountApplied ?? data.loyaltyDiscountApplied ?? 0);
            const walletPointsLeft      = Number(data.walletPointsLeft ?? 0);
            const remaining             = Number(data.remainingToPay ?? 0);
            const newOrderDiscount      = Number(data.orderDiscount ?? 0);

            if (walletAppliedEl)  walletAppliedEl.textContent   = walletDiscountApplied.toFixed(2);
            if (walletBalanceEl)  walletBalanceEl.textContent   = String(walletPointsLeft);
            if (orderTotal)       orderTotal.textContent        = remaining.toFixed(2);
            if (orderDiscountEl)  orderDiscountEl.textContent   = newOrderDiscount.toFixed(2);

            updateCardPayAmount(remaining);

            walletMsg.textContent = data.message || `Loyalty points applied successfully.`;
            walletMsg.style.color = '#166534';
            toast('Wallet applied', true);

            // show remove button (UI reset only; remove API needs backend if you want true rollback)
            if (walletRemoveBtn) walletRemoveBtn.style.display = 'inline-block';

        } catch(e){
            console.error(e);
            walletMsg.textContent = 'Something went wrong. Please try again.';
            walletMsg.style.color = '#b91c1c';
            toast('Error applying wallet', false);
        } finally {
            walletApplyBtn.disabled = false;
            walletApplyBtn.textContent = oldText;
        }
    }

    walletApplyBtn?.addEventListener('click', applyWalletPoints);
    walletPtsInput?.addEventListener('keydown', e => {
        if (e.key === 'Enter'){ e.preventDefault(); applyWalletPoints(); }
    });

    // UI-only remove (resets input + message; does NOT restore points server-side)
    walletRemoveBtn?.addEventListener('click', () => {
        if (walletPtsInput) walletPtsInput.value = '';
        if (walletAppliedEl) walletAppliedEl.textContent = '0.00';
        walletMsg.textContent = 'Loyalty wallet removed.';
        walletMsg.style.color = '#6b7280';
        walletRemoveBtn.style.display = 'none';
    });

    // ---------- PayPal ----------
    document.getElementById('btn-paypal')?.addEventListener('click', async () => {
        try{
            toast('Redirecting to PayPal...', true);
            const r = await fetch('/payment/paypal/start', {
                method:'POST',
                headers: withCsrf(),
                body: JSON.stringify({ orderId: ORDER_ID })
            });
            if(!r.ok) throw new Error();
            const data = await r.json();
            if(!data || !data.approvalUrl) throw new Error();
            setTimeout(() => { location.href = data.approvalUrl; }, 500);
        } catch(e){
            console.error('PayPal Error:', e);
            toast('PayPal unavailable', false);
        }
    });

    // =============================
    //      STRIPE INIT
    // =============================
    const stripe   = STRIPE_KEY ? Stripe(STRIPE_KEY) : null;
    const elements = stripe ? stripe.elements() : null;

    // =============================
    //      INLINE CARD PAYMENT
    // =============================
    let cardElement = null;
    const cardFormWrapper = document.getElementById('card-form-wrapper');
    const btnCard         = document.getElementById('btn-card');
    const cardForm        = document.getElementById('card-form');
    const cardSubmit      = document.getElementById('card-submit');
    const cardClose       = document.getElementById('card-close');
    const cardCancel      = document.getElementById('card-cancel');

    function showCardForm(){
        if (!stripe || !elements){
            toast('Card payments are not available right now.', false);
            return;
        }
        cardFormWrapper.style.display = 'block';
        if (!cardElement){
            const style = {
                base: {
                    color: '#111827',
                    fontFamily: 'system-ui, -apple-system, "Segoe UI", sans-serif',
                    fontSize: '14px',
                    '::placeholder': { color: '#9ca3af' }
                },
                invalid: { color: '#b91c1c' }
            };
            cardElement = elements.create('card', { style });
            cardElement.mount('#card-element');
        }
        document.getElementById('cardholder-name')?.focus();
    }

    function hideCardForm(){ cardFormWrapper.style.display = 'none'; }

    btnCard?.addEventListener('click', showCardForm);
    cardClose?.addEventListener('click', hideCardForm);
    cardCancel?.addEventListener('click', hideCardForm);

    async function createPaymentIntent(){
        const res = await fetch('/payment/stripe/start', {
            method:'POST',
            headers: withCsrf(),
            body: JSON.stringify({ orderId: ORDER_ID })
        });
        if (!res.ok) throw new Error('Failed to create PaymentIntent');
        const data = await res.json();
        if (data.status && data.status !== 'success') {
            throw new Error(data.message || 'PaymentIntent creation failed');
        }
        return data;
    }

    async function confirmStripePaymentOnServer(orderId, paymentId, paymentIntentId){
        const res = await fetch('/payment/stripe/confirm', {
            method: 'POST',
            headers: withCsrf(),
            body: JSON.stringify({ orderId, paymentId, paymentIntentId })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.status !== 'success'){
            throw new Error(data.message || 'Server confirm failed');
        }
    }

    cardForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!stripe || !cardElement) return;

        const name  = document.getElementById('cardholder-name')?.value || '';
        const email = document.getElementById('billing-email')?.value || '';
        const zip   = document.getElementById('billing-zip')?.value || '';

        cardSubmit.disabled = true;
        const oldLabel = cardSubmit.textContent;
        cardSubmit.textContent = 'Processing…';

        try {
            const { clientSecret, paymentId } = await createPaymentIntent();
            if (!clientSecret) throw new Error('No clientSecret from server');
            if (!paymentId) throw new Error('No paymentId from server');

            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: { name, email, address: { postal_code: zip } }
                }
            });

            if (error) {
                console.error(error);
                toast(error.message || 'Card was declined', false);
                cardSubmit.disabled = false;
                cardSubmit.textContent = oldLabel;
                return;
            }

            if (paymentIntent?.status === 'succeeded') {
                await confirmStripePaymentOnServer(ORDER_ID, paymentId, paymentIntent.id);
                toast('Payment successful! Redirecting…', true);
                window.location.href = '/payment/success?orderId=' + ORDER_ID + '&paymentId=' + paymentId;
                return;
            }

            toast('Payment status: ' + (paymentIntent?.status || 'unknown'), false);
            cardSubmit.disabled = false;
            cardSubmit.textContent = oldLabel;

        } catch (err) {
            console.error(err);
            toast('Payment failed. Please try again.', false);
            cardSubmit.disabled = false;
            cardSubmit.textContent = oldLabel;
        }
    });

    async function canUseWallet(){
        if(!stripe) return null;
        const pr = stripe.paymentRequest({
            country:'US',
            currency:'usd',
            total:{label:'SpiceJar Order', amount:1},
            requestPayerName:true,
            requestPayerEmail:true
        });
        try{ return await pr.canMakePayment(); } catch { return null; }
    }

    async function payWithWallet(kind){
        try{
            const capability = await canUseWallet();
            if(!capability){
                toast(kind + ' Pay not available on this device. Using secure card form…', true);
                showCardForm();
                return;
            }

            const { clientSecret, paymentId } = await createPaymentIntent();
            if(!clientSecret) throw new Error('No client secret returned');
            if(!paymentId) throw new Error('No paymentId returned');

            const { error, paymentIntent } = await stripe.confirmPayment({
                clientSecret,
                redirect: "if_required"
            });

            if(error){
                console.error(error);
                toast('Wallet payment failed', false);
                return;
            }

            if (paymentIntent?.status === "succeeded") {
                await confirmStripePaymentOnServer(ORDER_ID, paymentId, paymentIntent.id);
                toast('Payment successful! Redirecting…', true);
                window.location.href = '/payment/success?orderId=' + ORDER_ID + '&paymentId=' + paymentId;
                return;
            }

            toast('Payment status: ' + (paymentIntent?.status || 'unknown'), false);

        }catch(e){
            console.error(e);
            toast('Wallet payment unavailable', false);
        }
    }

    document.getElementById('btn-apple')?.addEventListener('click', () => payWithWallet('Apple'));
    document.getElementById('btn-google')?.addEventListener('click', () => payWithWallet('Google'));
</script>

</body>
</html>
