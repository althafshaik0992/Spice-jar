<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Choose Payment • The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSRF (used by fetch POSTs) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#f6fbf6;margin:0;color:#111}
        .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6ece7;padding:10px 6%;display:flex;gap:16px;align-items:center;justify-content:space-between}
        .brand{display:flex;align-items:center;gap:8px;color:#218838;text-decoration:none;font-weight:900}
        main{max-width:1100px;margin:22px auto;padding:0 6%}
        h1{margin:0 0 8px;color:#218838}
        .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
        @media(max-width:980px){.grid{grid-template-columns:1fr}}
        .card{background:#fff;border:1px solid #e6ece7;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:16px}
        .option{display:flex;align-items:center;justify-content:space-between;border:1px solid #e6ece7;border-radius:12px;padding:14px;margin-top:10px}
        .left{display:flex;gap:12px;align-items:center}
        .icon{width:44px;height:44px;display:grid;place-items:center;border-radius:10px;background:#eef8f0;color:#218838;font-size:20px}
        .btn{border:none;cursor:pointer;border-radius:10px;padding:10px 14px;font-weight:800}
        .btn.primary{background:#218838;color:#fff}
        .btn.ghost{background:#fff;border:1px solid #dcdcdc}
        .row{display:flex;justify-content:space-between;margin:6px 0}
        .total{font-weight:900}
        .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999}
    </style>
</head>
<body>

<nav class="bar">
    <a th:href="@{/}" class="brand">
        <video th:src="@{/images/Spice-Jar.mp4}" autoplay muted loop playsinline style="height:32px;border-radius:6px"></video>
        <span>SpiceJar</span>
    </a>
    <div style="display:flex;gap:14px;align-items:center">
        <a th:href="@{/}">Home</a>
        <a th:href="@{/products}">Products</a>
        <a th:href="@{/cart/view}">Cart</a>
        <a th:href="@{/orders}">My Orders</a>
    </div>
</nav>

<main>
    <h1>Choose your payment method</h1>
    <p style="color:#64748b;margin:6px 0 14px">Select a secure option to complete your order.</p>

    <section class="grid">
        <!-- left -->
        <div class="card">
            <!-- Stripe Checkout -->
            <div class="option">
                <div class="left">
                    <div class="icon"><i class="fa-solid fa-credit-card"></i></div>
                    <div>
                        <div style="font-weight:800">Credit / Debit Card</div>
                        <div style="color:#6b7280;font-size:14px">Secure payment via Stripe Checkout.</div>
                    </div>
                </div>
                <button id="btn-card" class="btn primary">Pay with card</button>
            </div>

            <!-- PayPal (server redirect) -->
            <div class="option">
                <div class="left">
                    <div class="icon"><i class="fa-brands fa-paypal"></i></div>
                    <div>
                        <div style="font-weight:800">PayPal</div>
                        <div style="color:#6b7280;font-size:14px">You’ll be redirected to PayPal to approve.</div>
                    </div>
                </div>
                <button id="btn-paypal" class="btn ghost">Continue with PayPal</button>
            </div>
        </div>

        <!-- right -->
        <aside class="card">
            <h3 style="margin:0 0 8px">Shipping address</h3>
            <div class="row"><span style="color:#6b7280">Name</span><span th:text="${order.customerName}">—</span></div>
            <div class="row"><span style="color:#6b7280">Street</span><span th:text="${order.street}">—</span></div>
            <div class="row"><span style="color:#6b7280">City</span><span th:text="${order.city}">—</span></div>
            <div class="row"><span style="color:#6b7280">State</span><span th:text="${order.state}">—</span></div>
            <div class="row"><span style="color:#6b7280">ZIP</span><span th:text="${order.zip}">—</span></div>
            <div class="row"><span style="color:#6b7280">Country</span><span th:text="${order.country}">—</span></div>
            <div class="row"><span style="color:#6b7280">Phone</span><span th:text="${order.phone}">—</span></div>
            <div class="row"><span style="color:#6b7280">Email</span><span th:text="${order.email}">—</span></div>
            <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
            <div class="row"><span>Subtotal</span><span th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
            <div class="row"><span>Tax (8%)</span><span th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}">$0.00</span></div>
            <div class="row total"><span>Total</span><span th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
        </aside>
    </section>
</main>

<script th:inline="javascript">
    const ORDER_ID = /*[[${order.id}]]*/ 0;

    const CSRF       = document.querySelector('meta[name="_csrf"]')?.content || '';
    const CSRF_HEADER= document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
    const withCsrf   = (h={}) => ({...h, [CSRF_HEADER]: CSRF, 'Content-Type':'application/json'});

    function toast(msg, ok=true){
        const t = document.createElement('div');
        t.className = 'toast';
        t.style.background = ok ? '#218838' : '#b00020';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1600);
    }

    // PayPal -> server creates order and returns approvalUrl
    document.getElementById('btn-paypal').addEventListener('click', async () => {
        try{
            const r = await fetch('/payment/paypal/start', {method:'POST', headers:withCsrf(), body: JSON.stringify({orderId: ORDER_ID})});
            if(!r.ok) throw new Error();
            const data = await r.json();
            if(!data || !data.approvalUrl){ throw new Error(); }
            location.href = data.approvalUrl; // go to PayPal
        }catch(e){ toast('PayPal unavailable', false); }
    });

    // Stripe Checkout -> server creates session and returns url
    document.getElementById('btn-card').addEventListener('click', async () => {
        try{
            const r = await fetch('/payment/stripe/start', {method:'POST', headers:withCsrf(), body: JSON.stringify({orderId: ORDER_ID})});
            if(!r.ok) throw new Error();
            const data = await r.json();
            if(!data || !data.checkoutUrl){ throw new Error(); }
            location.href = data.checkoutUrl; // hosted checkout
        }catch(e){ toast('Card payment unavailable', false); }
    });
</script>
</body>
</html>
