<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>The Spice Jar</title>

    <!-- CSRF for Spring Security (chat + cart) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- SEO / Social -->
    <meta name="description" content="Premium Indian spices and blends delivered fresh. Shop bestsellers like Garam Masala, Turmeric, and more."/>
    <meta property="og:title" content="The Spice Jar"/>
    <meta property="og:description" content="Premium Indian spices & blends delivered fresh."/>
    <meta property="og:image" content="/images/spices-about.jpeg"/>
    <meta property="og:type" content="website"/>

    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

    <style>
        :root { --green:#218838; --accent:#b7410e; --dark:#111; }
        * { box-sizing: border-box; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f0f8f0; color:#222; }
        a:focus, button:focus, input:focus { outline: 3px solid #94d3a2; outline-offset: 2px; }

        /* Promo bar */
        .promo { background:#0f5132;color:#fff;padding:6px 6%;font-weight:700;text-align:center }

        /* Navbar */
        .navbar{
            background:#fff; padding:6px 6%;
            box-shadow:0 2px 6px rgba(0,0,0,.05);
            display:flex; gap:16px; align-items:center; position:sticky; top:0; z-index:1000; height:60px;
        }
        .brand-logo{display:flex; align-items:center; gap:8px; text-decoration:none; color:var(--green); font-weight:700; font-size:20px}
        .brand-logo video{width:36px; height:auto; border-radius:4px}

        /* Nav search */
        .nav-search{flex:1; max-width:520px; display:flex; align-items:center; gap:8px}
        .nav-search input{
            width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:999px;
            background:#fff; font-size:14px; outline:none;
        }
        .nav-search button{
            border:none; border-radius:999px; padding:9px 12px; background:var(--green); color:#fff; cursor:pointer;
        }
        .nav-search button:hover{background:var(--accent);}

        .nav-links{display:flex; align-items:center; gap:18px; margin-left:auto;}
        .nav-links a{text-decoration:none; color:#333; font-weight:500; font-size:15px}
        .nav-links a:hover{color:#218838}

        .dropdown{position:relative}
        .dropdown-toggle{background:none; border:none; cursor:pointer; font-size:15px; color:#333; display:flex; align-items:center; gap:6px}
        .dropdown-menu{display:none; position:absolute; right:0; top:100%; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.1); border-radius:6px; overflow:hidden; min-width:180px}
        .dropdown:hover .dropdown-menu{display:block}
        .dropdown-menu a, .dropdown-menu span{display:block; padding:10px 16px; text-decoration:none; color:#333; white-space:nowrap}
        .dropdown-menu a:hover{background:#f4f4f4}

        /* Cart badge */
        .cart-icon-container { position: relative; display: inline-block; }
        .cart-count-badge {
            position: absolute; top: -8px; right: -8px; background-color: var(--accent);
            color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; text-align: center;
        }

        /* Hero */
        .hero{
            display:flex; align-items:center; justify-content:space-between;
            background:var(--green); color:#fff; padding:28px 6%;
            min-height:50vh; position: relative; overflow: hidden;
        }
        .hero-left h1{font-size:40px; line-height:1.15; margin:0 0 12px}
        .cta{background:#fff; color:var(--green); padding:10px 18px; border-radius:30px; text-decoration:none; font-weight:600}
        .hero-right { position: relative; }
        .hero-image-revolver { position: relative; width: 420px; height: 280px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.2); }
        .hero-image-revolver img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; animation: fade 16s infinite; }
        .hero-image-revolver img:nth-child(1) { animation-delay: 0s; }
        .hero-image-revolver img:nth-child(2) { animation-delay: 4s; }
        .hero-image-revolver img:nth-child(3) { animation-delay: 8s; }
        .hero-image-revolver img:nth-child(4) { animation-delay: 12s; }
        @keyframes fade { 0%{opacity:0} 5%{opacity:1} 25%{opacity:1} 30%{opacity:0} 100%{opacity:0} }

        /* Category chips */
        .chipbar{padding:12px 6%;display:flex;gap:10px;flex-wrap:wrap;background:#fff}
        .chip{border:1px solid #dfe6df;background:#fff;color:#333;padding:8px 12px;border-radius:999px;font-weight:700;text-decoration:none}
        .chip:hover{border-color:#218838;color:#218838}

        /* Product grid */
        .menu-section{padding:40px 6%}
        .menu-section h2{text-align:center; margin:0 0 24px; color:var(--green)}
        .cards{display:flex; flex-wrap:wrap; gap:24px; justify-content:center}
        .card{width:280px; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.08); display:flex; flex-direction:column}
        .card img{width:100%; height:200px; object-fit:cover}
        .card-body{padding:16px; text-align:center}
        .pill{background:#eef6f0; border:1px solid #d7eadf; color:#1e7e34; padding:4px 10px; border-radius:999px; font-weight:600; font-size:12px}
        .btn-order{background:var(--green); color:#fff; padding:10px 16px; border-radius:30px; border:none; cursor:pointer}
        .btn-order:hover{background:var(--accent)}
        .order-now-wrap{display:flex; justify-content:center; margin-top:22px}
        .order-now{
            display:inline-flex; align-items:center; gap:8px;
            background:var(--green); color:#fff; font-weight:800;
            padding:12px 18px; border-radius:999px; text-decoration:none;
            box-shadow:0 8px 24px rgba(0,0,0,.12);
        }
        .order-now:hover{background:var(--accent)}

        /* Sections */
        .section{padding:30px 6%;background:#fff}
        .section h2{color:#218838;text-align:center;margin:0 0 16px}
        .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}

        /* Footer */
        .site-footer{background:#222; color:#fff; padding:40px 6%; margin-top:40px}
        .footer-container{display:flex; flex-wrap:wrap; justify-content:space-between; gap:30px; margin-bottom:30px}
        .footer-column{flex:1; min-width:220px}
        .footer-column h3{color:#fff; margin-bottom:15px; font-weight:600; border-bottom:2px solid var(--green); padding-bottom:8px; display:inline-block}
        .footer-column p{line-height:1.6; font-size:14px}
        .footer-column ul{list-style:none; padding:0; margin:0}
        .footer-column ul li a{text-decoration:none; color:#ccc; display:block; padding:5px 0; font-size:14px; transition:color .3s}
        .footer-column ul li a:hover{color:#fff}
        .footer-bottom{text-align:center; padding-top:20px; border-top:1px solid #444; font-size:14px}

        @media (max-width: 900px){
            .nav-links{display:none}
        }

        /* Chat (existing styles) */
        .sj-chat-toggle {
            position: fixed; right: 20px; bottom: 20px; z-index: 1200;
            width: 56px; height: 56px; border-radius: 50%;
            display: grid; place-items: center; border: none; cursor: pointer;
            background: var(--green); color: #fff; box-shadow: 0 6px 18px rgba(0,0,0,.2);
        }
        .sj-chat-toggle:hover { background: var(--accent); }
        .sj-chat { position: fixed; right: 20px; bottom: 92px; z-index: 1200; width: 340px; max-height: 70vh; border-radius: 14px; overflow: hidden; background: #fff; box-shadow: 0 20px 40px rgba(0,0,0,.2); display: none; flex-direction: column; }
        .sj-chat.open { display: flex; }
        .sj-chat__header { background: var(--green); color: #fff; padding: 12px 14px; display: flex; align-items: center; gap: 10px; }
        .sj-chat__title { font-weight: 700; font-size: 15px; }
        .sj-chat__subtitle { font-size: 12px; opacity: .9; }
        .sj-chat__body { padding: 12px; background: #f7faf7; overflow-y: auto; flex: 1; }
        .sj-msg { display: flex; gap: 8px; margin-bottom: 10px; }
        .sj-msg.bot .bubble { background: #fff; color: #222; border: 1px solid #eee; }
        .sj-msg.user { justify-content: flex-end; }
        .sj-msg.user .bubble { background: var(--green); color:#fff; }
        .bubble { max-width: 78%; padding: 10px 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); font-size: 14px; line-height: 1.35; }
        .sj-chat__quick { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px; }
        .sj-chip { border:1px solid #dfe6df; background:#fff; color:#333; padding:6px 10px; border-radius:20px; cursor:pointer; font-size:12px; }
        .sj-chip:hover { border-color: var(--green); color: var(--green); }
        .sj-chat__input { padding:10px; background:#fff; border-top:1px solid #eee; display:flex; gap:8px; }
        .sj-chat__input input { flex:1; border:1px solid #ddd; border-radius:20px; padding:10px 12px; outline:none; font-size:14px; background:#fff; }
        .sj-send { border:none; background:var(--green); color:#fff; border-radius:20px; padding:0 14px; cursor:pointer; font-weight:600; }
        .sj-send:disabled { opacity:.6; cursor:not-allowed; }

        /* Toast + Back to top */
        #sj-toast{position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:12px 14px;border-radius:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.3);z-index:1300}
        #backTop{position:fixed;right:20px;bottom:90px;display:none;border:0;border-radius:50%;width:42px;height:42px;background:#111;color:#fff;cursor:pointer}
        .social-links a { color: #ccc; text-decoration: none; font-size: 20px; margin-right: 15px; transition: color 0.3s; }
        .social-links a:hover { color: var(--green); }
        .footer-bottom { text-align: center; padding-top: 20px; border-top: 1px solid #444; font-size: 14px; }
        @media (max-width: 768px) { .footer-container { flex-direction: column; text-align: center; } .footer-column { margin-bottom: 20px; } }
    </style>
</head>
<body>

<!-- Promo bar -->
<div class="promo">
    Free shipping on orders over $35 ‚Ä¢ <a href="/menu" style="color:#b8ffd6;text-decoration:underline">Shop now</a>
</div>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <!-- Compact search -> /menu?q=... -->
    <form class="nav-search" role="search" onsubmit="return false;">
        <input id="nav-q" type="search" placeholder="Search spices‚Ä¶" aria-label="Search" th:value="${q}">
        <button id="nav-search-btn" type="button" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <!-- Account -->
        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>
                <span th:if="${session.USER != null}">
          Welcome, <strong th:text="${session.USER.firstName}">User</strong>
        </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>

<!-- Hero -->
<section class="hero">
    <div class="hero-left">
        <h1>Flavors that Inspire, Spices that Transform.</h1>
        <p>Discover a world of aromatic spices, curated for your culinary adventures.</p>
        <a href="#menu" class="cta">Explore Spices</a>
    </div>
    <div class="hero-right">
        <div class="hero-image-revolver">
            <img loading="eager" decoding="async" width="420" height="280" sizes="(max-width: 600px) 90vw, 420px"
                 th:src="@{/images/spices-about.jpeg}" alt="Assorted spices on a tray"/>
            <img loading="lazy" decoding="async" width="420" height="280" sizes="(max-width: 600px) 90vw, 420px"
                 th:src="@{/images/chilli powder.jpeg}" alt="Chili powder"/>
            <img loading="lazy" decoding="async" width="420" height="280" sizes="(max-width: 600px) 90vw, 420px"
                 th:src="@{/images/download (2).jpeg}" alt="Cloves"/>
            <img loading="lazy" decoding="async" width="420" height="280" sizes="(max-width: 600px) 90vw, 420px"
                 th:src="@{/images/download (3).jpeg}" alt="Cardamom pods"/>
        </div>
    </div>
</section>

<!-- Category chips -->
<div class="chipbar">
    <a class="chip" href="/menu?category=Masalas">Masalas</a>
    <a class="chip" href="/menu?category=Whole%20Spices">Whole Spices</a>
    <a class="chip" href="/menu?category=Blends">Blends</a>
    <a class="chip" href="/menu?category=Herbs">Herbs</a>
</div>

<!-- Product grid -->
<section id="menu" class="menu-section">
    <h2>Best Sellers</h2>

    <div class="cards">
        <!-- Show only first 4 items -->
        <div class="card" th:each="product, stat : ${products}" th:if="${stat.index < 4}">
            <img loading="lazy" decoding="async" width="280" height="200" sizes="(max-width: 600px) 92vw, 280px"
                 th:src="@{${#strings.isEmpty(product.imageUrl) ? '/images/chilli%20powder.jpeg' : product.imageUrl}}"
                 alt="Spices Product"/>
            <div class="card-body">
                <!-- star + badge -->
                <div class="row" style="justify-content:center;gap:6px;margin-bottom:6px;display:flex">
                    <span aria-label="4.8 out of 5 stars">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚ú©</span>
                    <span class="pill">Bestseller</span>
                </div>

                <h5 th:text="${product.name}">Product Name</h5>
                <h4>$ <span th:text="${#numbers.formatDecimal(product.price,1,'COMMA',2,'POINT')}">0.00</span></h4>

                <div class="meta" th:if="${product.weight != null}" style="margin:6px 0">
                    <span class="pill" th:text="${product.weight != null ? #numbers.formatInteger(product.weight, 1, 'COMMA') + ' g' : '‚Äî'}">250 g</span>
                </div>

                <p th:text="${product.description}">Product description.</p>

                <button class="btn-order add-to-cart-btn"
                        th:data-product-id="${product.id}"
                        th:data-product-name="${product.name}"
                        th:data-product-image="${product.imageUrl}"
                        th:data-product-price="${product.price}">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </div>
    </div>

    <div class="order-now-wrap">
        <a class="order-now" th:href="@{/menu}">
            <i class="fa-solid fa-bowl-food"></i> Order Now
        </a>
    </div>
</section>

<!-- Testimonials -->
<section class="section">
    <h2>What our customers say</h2>
    <div class="grid-3">
        <blockquote style="background:#f8fff8;border:1px solid #dceedd;border-radius:12px;padding:14px">
            ‚ÄúSuper fresh spices. My curries taste restaurant-level now!‚Äù ‚Äî Priya S.
        </blockquote>
        <blockquote style="background:#f8fff8;border:1px solid #dceedd;border-radius:12px;padding:14px">
            ‚ÄúFast delivery and great aroma out of the jar.‚Äù ‚Äî David G.
        </blockquote>
        <blockquote style="background:#f8fff8;border:1px solid #dceedd;border-radius:12px;padding:14px">
            ‚ÄúGaram masala blend is perfect‚Äîbalanced and lively.‚Äù ‚Äî Asha R.
        </blockquote>
    </div>
</section>

<!-- Why us -->
<section class="section">
    <div class="grid-3" style="text-align:center">
        <div><div style="font-size:28px">üü¢</div><h3>Freshly Packed</h3><p class="muted">Small batches, sealed aroma.</p></div>
        <div><div style="font-size:28px">üöö</div><h3>Fast Shipping</h3><p class="muted">2‚Äì5 day delivery.</p></div>
        <div><div style="font-size:28px">‚úÖ</div><h3>Quality Assured</h3><p class="muted">100% satisfaction.</p></div>
    </div>
</section>

<!-- Newsletter -->
<section class="section" style="background:#f0f8f0;text-align:center">
    <h2>Get recipes & offers</h2>
    <form th:action="@{/subscribe}" method="post" style="display:inline-flex;gap:8px;flex-wrap:wrap">
        <input type="email" name="email" placeholder="your@email.com"
               style="padding:10px 12px;border:1px solid #ddd;border-radius:999px" required>
        <button class="order-now" type="submit" style="border:none">Subscribe</button>
    </form>
    <p class="muted" style="margin-top:6px">No spam. Unsubscribe anytime.</p>
</section>

<!-- Footer -->
<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>About Spice Jar</h3>
            <p>Bringing the world's finest spices to your kitchen. Quality, aroma, and flavor guaranteed in every jar.</p>
        </div>
        <div class="footer-column">
            <h3>Quick Links</h3>
            <ul>
                <li><a th:href="@{/menu}">Menu</a></li>
                <li><a th:href="@{/about}">About Us</a></li>
                <li><a th:href="@{/contact}">Contact</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Connect With Us</h3>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 The Spice Jar. All rights reserved.</p>
    </div>
</footer>

<!-- Chat toggle -->
<button class="sj-chat-toggle" id="sj-toggle" aria-label="Chat with Spice AI">
    <i class="fa-solid fa-comment"></i>
</button>

<!-- Chat panel -->
<div class="sj-chat" id="sj-chat" aria-live="polite" aria-label="Chat window">
    <div class="sj-chat__header">
        <div>
            <div class="sj-chat__title">Spice AI</div>
            <div class="sj-chat__subtitle">Ask about menu, add to cart, checkout‚Ä¶</div>
        </div>
    </div>
    <div class="sj-chat__body" id="sj-body">
        <div class="sj-msg bot"><div class="bubble">Hi! I‚Äôm Spice AI üå∂Ô∏è Try ‚Äúfind turmeric‚Äù, ‚Äúadd garam masala 2‚Äù, or ‚Äúcheckout‚Äù.</div></div>
        <div class="sj-chat__quick" id="sj-quick">
            <button class="sj-chip" data-q="find turmeric">Find turmeric</button>
            <button class="sj-chip" data-q="add cumin 2">Add cumin 2</button>
            <button class="sj-chip" data-q="checkout">Checkout</button>
        </div>
    </div>
    <div class="sj-chat__input">
        <input id="sj-input" type="text" placeholder="Type your message‚Ä¶"/>
        <button class="sj-send" id="sj-send" disabled>Send</button>
    </div>
</div>

<!-- Toast + Back to top -->
<div id="sj-toast">Added to cart ‚úì</div>
<button id="backTop" aria-label="Back to top">‚Üë</button>

<!-- Example JSON-LD (static sample; you can render dynamically later) -->
<script type="application/ld+json">
    {
        "@context":"https://schema.org",
        "@type":"Product",
        "name":"Garam Masala",
        "image":"/images/chilli%20powder.jpeg",
        "description":"Aromatic blend for curries.",
        "brand": {"@type": "Brand","name": "SpiceJar"},
        "aggregateRating": {"@type":"AggregateRating","ratingValue":"4.8","reviewCount":"215"},
        "offers": {"@type":"Offer","priceCurrency":"USD","price":"6.99","availability":"https://schema.org/InStock"}
    }
</script>

<script>
    (function () {
        const csrf       = document.querySelector('meta[name="_csrf"]')?.content || '';
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

        /* ---- NAV SEARCH: /menu?q=... ---- */
        const qInput = document.getElementById('nav-q');
        const goSearch = () => {
            const q = (qInput?.value || '').trim();
            const url = q ? `/menu?q=${encodeURIComponent(q)}` : '/menu';
            window.location.href = url;
        };
        document.getElementById('nav-search-btn')?.addEventListener('click', goSearch);
        qInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(); }});

        // keyboard shortcut: focus with '/', blur with ESC
        document.addEventListener('keydown', (e)=>{
            if (!qInput) return;
            const tag = (document.activeElement?.tagName || '').toLowerCase();
            if(e.key==='/' && tag!=='input' && tag!=='textarea'){
                e.preventDefault(); qInput.focus();
            }
            if(e.key==='Escape' && document.activeElement===qInput){ qInput.blur(); }
        });

        /* ---- CART: update badge + toast + analytics ---- */
        function updateCartCount(count){
            const el=document.getElementById('lblCartCount'); if(el && Number.isFinite(count)) el.textContent=String(count);
        }
        const toast=(msg)=>{
            const t=document.getElementById('sj-toast'); if(!t) return;
            t.textContent=msg; t.style.display='block';
            setTimeout(()=>t.style.display='none',1600);
        };
        const logEvent=(name, data)=> {
            try {
                const b = new Blob([JSON.stringify({name, data, ts:Date.now()})], {type:'application/json'});
                if (!navigator.sendBeacon || !navigator.sendBeacon('/api/analytics', b)) {
                    // fallback
                    fetch('/api/analytics', {method:'POST', body:b, headers:{[csrfHeader]: csrf}});
                }
            } catch(e){ /* ignore */ }
        };

        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const productId = e.currentTarget.getAttribute('data-product-id');
                const price     = Number(e.currentTarget.getAttribute('data-product-price'));
                try{
                    const res = await fetch(`/cart/add?productId=${productId}&qty=1`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json', [csrfHeader]: csrf}
                    });
                    if(!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if (data.status === 'success') {
                        if (typeof data.cartCount !== 'undefined') updateCartCount(data.cartCount);
                        toast('Added to cart ‚úì');
                        logEvent('add_to_cart', { productId, price });
                    }
                }catch(err){
                    console.error(err);
                    toast('Could not add to cart');
                }
            });
        });

        /* ---- Chat widget (unchanged behavior) ---- */
        const toggle = document.getElementById('sj-toggle');
        const panel  = document.getElementById('sj-chat');
        const body   = document.getElementById('sj-body');
        const input  = document.getElementById('sj-input');
        const send   = document.getElementById('sj-send');
        const quick  = document.getElementById('sj-quick');
        const cartBadge = document.getElementById('lblCartCount');

        const addMsg=(role,text,actions)=>{
            const row=document.createElement('div');
            row.className='sj-msg ' + (role==='user'?'user':'bot');
            const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
            row.appendChild(b); body.appendChild(row);
            if(actions && actions.length){
                const wrap=document.createElement('div'); wrap.className='sj-actions';
                actions.forEach(a=>{
                    const link=document.createElement('a');
                    link.className='sj-action'; link.href=a.url; link.textContent=a.label;
                    wrap.appendChild(link);
                });
                body.appendChild(wrap);
            }
            body.scrollTop = body.scrollHeight;
        };

        toggle?.addEventListener('click', ()=> panel.classList.toggle('open'));
        input?.addEventListener('input', ()=> send.disabled = !input.value.trim());

        quick?.addEventListener('click', (e)=>{
            const btn = e.target.closest('[data-q]'); if(!btn) return;
            input.value = btn.getAttribute('data-q');
            send.disabled = !input.value.trim();
            send.click();
        });

        async function sendMsg(){
            const text = input.value.trim(); if(!text) return;
            addMsg('user', text); input.value=''; send.disabled=true;
            try{
                const r = await fetch('/api/chat', {
                    method:'POST',
                    headers: {'Content-Type':'application/json', [csrfHeader]: csrf},
                    body: JSON.stringify({ text })
                });
                const data = await r.json();
                const reply   = data.text ?? data.reply ?? 'Okay.';
                const actions = data.actions ?? null;
                const count   = data.cartCount;
                addMsg('bot', reply, actions);
                if(typeof count !== 'undefined' && cartBadge) cartBadge.textContent = String(count);
            }catch{ addMsg('bot','Sorry, I had trouble answering. Please try again.'); }
            finally{ send.disabled = !input.value.trim(); }
        }
        send?.addEventListener('click', sendMsg);
        input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMsg(); });

        /* ---- Back to top ---- */
        const bt = document.getElementById('backTop');
        window.addEventListener('scroll',()=>{ bt.style.display = window.scrollY>300?'block':'none'; });
        bt.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
    })();
</script>

</body>
</html>
