<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<head>
    <meta charset="utf-8">
    <title>Cart ‚Ä¢ The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{--green:#218838;--accent:#b7410e;--dark:#111;--bg:#f0f8f0}
        *{box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;background:var(--bg);color:#222}

        /* Navbar */
        .navbar{background:#fff;padding:6px 6%;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;height:60px}
        .brand-logo{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--green);font-weight:700;font-size:20px}
        .brand-logo video{width:36px;height:auto;border-radius:4px}
        .nav-links{display:flex;align-items:center;gap:18px}
        .nav-links a{text-decoration:none;color:#333;font-weight:500;font-size:15px}
        .nav-links a:hover{color:var(--green)}
        .dropdown{position:relative}
        .dropdown-toggle{background:none;border:none;cursor:pointer;font-size:15px;color:#333;display:flex;align-items:center;gap:6px}
        .dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.1);border-radius:6px;overflow:hidden;min-width:180px}
        .dropdown:hover .dropdown-menu{display:block}
        .dropdown-menu a,.dropdown-menu span{display:block;padding:10px 16px;text-decoration:none;color:#333;white-space:nowrap}
        .dropdown-menu a:hover{background:#f4f4f4}
        .cart-icon-container{position:relative;display:inline-block}
        .cart-count-badge{position:absolute;top:-8px;right:-8px;background:var(--accent);color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}

        /* NEW: compact navbar search */
        .nav-search{flex:1; max-width:520px; display:flex; align-items:center; gap:8px}
        .nav-search input{
            width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:999px;
            background:#fff; font-size:14px; outline:none;
        }
        .nav-search button{
            border:none; border-radius:999px; padding:9px 12px; background:var(--green); color:#fff; cursor:pointer;
        }
        .nav-search button:hover{background:var(--accent);}

        /* Layout */
        .container{max-width:1200px;margin:24px auto;padding:0 2%}
        .cart-grid{display:grid;grid-template-columns:1fr 340px;gap:24px;align-items:flex-start}
        @media (max-width:900px){.cart-grid{grid-template-columns:1fr}}

        /* Cart area */
        .cart-items-container{background:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:24px}
        .cart-header{display:flex;justify-content:space-between;align-items:baseline;border-bottom:1px solid #eee;padding-bottom:10px}
        .cart-header h1{font-size:28px;margin:0;color:var(--dark)}
        .cart-header a{font-size:14px;color:var(--green);text-decoration:none}
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .giftcard-img {
            width:150px; height:150px; object-fit:contain; border-radius:12px;
            border:1px solid #f5c07a;
            padding:6px;
            box-shadow:0 3px 10px rgba(0,0,0,0.15);
            background: #fff linear-gradient(
                    110deg,
                    #fff8e1 25%,
                    #fff3cd 37%,
                    #fff8e1 63%
            );
            background-size: 400% 100%;
            animation: shimmer 2s infinite linear;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .giftcard-img:hover {
            transform: scale(1.04);
            box-shadow: 0 6px 16px rgba(183, 65, 14, 0.3);
        }

        .cart-item-card{display:flex;gap:16px;padding:20px 0;border-bottom:1px solid #eee}
        .cart-item-card:last-child{border-bottom:none}
        .item-image{flex-shrink:0;display:flex;align-items:flex-start;gap:15px}
        .item-image img{width:150px;height:150px;object-fit:contain;border-radius:8px}

        .item-details{flex-grow:1}
        .item-details h3{margin:0 0 6px 0;font-size:18px;font-weight:700}
        .small-muted{color:#6b7280;font-size:13px}
        .weight-pill{display:inline-block;margin-top:6px;background:#eef6f0;border:1px solid #d7eadf;color:#1e7e34;padding:2px 10px;border-radius:999px;font-weight:600;font-size:12px}

        .item-stock{color:var(--green);font-size:14px;font-weight:600;margin:10px 0}
        .item-actions-toolbar{display:flex;align-items:center;gap:15px;margin-top:10px}

        .btn-action{background:var(--green);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
        .btn-action:hover{background:var(--accent)}
        .separator{color:#ccc}

        .item-price{font-size:20px;font-weight:700;color:var(--accent);text-align:right}

        /* Qty selector */
        .quantity-selector{display:flex;align-items:center;border:1px solid #ccc;border-radius:5px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
        .quantity-selector button{background:#f0f0f0;border:none;padding:8px 12px;cursor:pointer;font-size:16px}
        .quantity-selector button:hover{background:#e0e0e0}
        .quantity-selector .qty-btn-minus{border-right:1px solid #ccc;border-radius:5px 0 0 5px}
        .quantity-selector .qty-btn-plus{border-left:1px solid #ccc;border-radius:0 5px 5px 0}
        .quantity-selector input{width:50px;text-align:center;border:none;font-size:16px;-moz-appearance:textfield}
        input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

        .cart-subtotal-footer{text-align:right;font-size:18px;margin-top:20px}

        /* Summary */
        .summary-card{background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.06);padding:20px;position:sticky;top:84px}
        .card h2{font-size:18px;margin:0 0 12px;color:#333}
        .row{display:flex;justify-content:space-between;margin:8px 0}
        .row.total{font-size:18px;font-weight:800}
        .btn-checkout{display:block;width:100%;text-align:center;background:var(--green);color:#fff;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:700;font-size:16px;border:none;margin-top:16px}
        .btn-checkout:hover{background:var(--accent)}

        /* Empty */
        .empty{background:#fff;border-radius:12px;padding:28px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.06)}
        .shop-link{display:inline-block;margin-top:6px;color:#fff;background:var(--green);padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:700}
        .shop-link:hover{background:var(--accent)}

        /* Tabs */
        .tabs{display:flex;border-bottom:1px solid #ccc;margin-bottom:24px}
        .tab-link{padding:12px 20px;text-decoration:none;color:#555;font-weight:600;border-bottom:2px solid transparent;position:relative;top:1px}
        .tab-link:hover{color:var(--green)}
        .tab-link.active{color:var(--green);border-bottom-color:var(--green)}
        .tab-content{display:none}
        .tab-content.active{display:block}

        /* Footer */
        .site-footer{background:#222;color:#ccc;padding:40px 6%;margin-top:40px}
        .footer-container{display:flex;flex-wrap:wrap;justify-content:space-between;gap:30px;margin-bottom:30px}
        .footer-column{flex:1;min-width:220px}
        .footer-column h3{color:#fff;margin-bottom:15px;font-weight:600;border-bottom:2px solid var(--green);padding-bottom:8px;display:inline-block}
        .footer-bottom{text-align:center;padding-top:20px;border-top:1px solid #444;font-size:14px}
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <form class="nav-search" role="search" onsubmit="return false;">
        <input id="nav-q" type="search" placeholder="Search spices‚Ä¶" aria-label="Search" th:value="${q}">
        <button id="nav-search-btn" type="button" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>
                <span th:if="${session.USER != null}">
          Welcome, <strong th:text="${session.USER.firstName}">User</strong>
        </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>

<div class="container">

    <!-- Empty -->
    <div class="empty"
         th:if="${(cart == null or cart.items == null or #lists.isEmpty(cart.items)) and
               (cart == null or cart.savedForLater == null or #lists.isEmpty(cart.savedForLater))}">
        <i class="fa-solid fa-bag-shopping" style="font-size:36px;color:var(--green)"></i>
        <p>Your cart is empty.</p>
        <a class="shop-link" th:href="@{/menu}">Browse Menu</a>
    </div>

    <!-- Tabs only when we have something -->
    <div th:if="${cart != null and ( (cart.items != null and !#lists.isEmpty(cart.items)) or
                                   (cart.savedForLater != null and !#lists.isEmpty(cart.savedForLater)) )}">
        <div class="tabs">
            <a href="#" class="tab-link active" data-tab="cart-tab">
                Shopping Cart (<span id="cartCountSpan" th:text="${cart.items.size()}">0</span>)
            </a>
            <a href="#" class="tab-link" data-tab="saved-tab">
                Saved for later (<span id="savedCountSpan" th:text="${cart.savedForLater.size()}">0</span>)
            </a>
        </div>
    </div>

    <!-- Cart tab -->
    <div id="cart-tab-content" class="tab-content active">
        <div th:if="${cart != null and cart.items != null and !#lists.isEmpty(cart.items)}">
            <div class="cart-grid">
                <!-- Items -->
                <main class="cart-items-container">
                    <div class="cart-header">
                        <h1>Shopping Cart</h1>
                        <a href="#">Deselect all items</a>
                    </div>


                    <div th:each="it : ${cart.items}" class="cart-item-card">
                        <div class="item-image">
                            <input type="checkbox" checked/>

                            <!-- üéÅ Gift card image -->
                            <img th:if="${it.name == 'SpiceJar email gift card' and it.description == 'Gift card for Althaf'}"
                                 src="/images/spicejar-giftcard.png"
                                 alt="Spice Jar Gift Card"
                                 class="giftcard-img"/>

                            <!-- üßÇ Default product image -->
                            <img th:if="${!(it.name == 'SpiceJar email gift card' and it.description == 'Gift card for Althaf')}"
                                 th:src="${#strings.isEmpty(it.imageUrl) ? '/images/chilli%20powder.jpeg' : it.imageUrl}"
                                 alt="Product Image"
                                 style="width:150px;height:150px;object-fit:contain;border-radius:10px;
                box-shadow:0 2px 8px rgba(0,0,0,0.05);"/>
                        </div>

                        <div class="item-details">
                            <div th:if="${it.name == 'SpiceJar email gift card' and it.description == 'Gift card for Althaf'}"
                                 class="giftcard-badge"
                                 style="background:#fff8e1;color:#b7410e;font-weight:700;
                border-radius:8px;padding:4px 10px;display:inline-block;
                margin-bottom:8px;">
                                üéÅ Spice Jar Gift Card
                            </div>

                            <h3 th:text="${it.name}">Product name</h3>

                            <div class="small-muted" th:if="${it.description != null}" th:text="${it.description}">
                                Product short description.
                            </div>

                            <span class="weight-pill" th:if="${it.weightGrams != null}"
                                  th:text="${it.weightGrams} + ' g'">500 g</span>

                            <div class="item-stock">In Stock</div>

                            <div class="item-actions-toolbar">
                                <form th:action="@{/cart/update}" method="post"
                                      class="quantity-form" style="display:inline-flex;align-items:center;gap:10px">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="productId" th:value="${it.productId}"/>
                                    <div class="quantity-selector">
                                        <button type="button" class="qty-btn-minus" th:attr="data-product-id=${it.productId}">-</button>
                                        <input type="number" name="qty" th:value="${it.qty}" min="1" class="qty-input"
                                               th:id="'qty-input-' + ${it.productId}"/>
                                        <button type="button" class="qty-btn-plus" th:attr="data-product-id=${it.productId}">+</button>
                                    </div>
                                </form>

                                <span class="separator">|</span>

                                <form th:action="@{/cart/update}" method="post" style="display:inline">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="productId" th:value="${it.productId}"/>
                                    <input type="hidden" name="qty" value="0"/>
                                    <button type="submit" class="btn-action">Delete</button>
                                </form>

                                <span class="separator">|</span>

                                <form th:action="@{/cart/saveForLater}" method="post" style="display:inline">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="productId" th:value="${it.productId}"/>
                                    <button type="submit" class="btn-action">Save for later</button>
                                </form>

                                <span class="separator">|</span>
                                <a th:href="@{/menu}" class="small-muted">Compare with similar items</a>
                            </div>
                        </div>

                        <!-- üí∞ Safe price rendering -->
                        <div class="item-price" th:if="${it != null and it.price != null}">
                            $ <span th:text="${#numbers.formatDecimal(it.price,1,'COMMA',2,'POINT')}">0.00</span>
                        </div>
                        <div class="item-price" th:if="${it == null or it.price == null}">
                            $ 0.00
                        </div>
                    </div>

                    <div class="cart-subtotal-footer">
                        Subtotal (<span th:text="${cart.items.size()}">0</span> items):
                        <strong th:text="${#numbers.formatDecimal(cart.subtotal,1,'COMMA',2,'POINT')}">$0.00</strong>
                    </div>
                </main>

                <!-- Summary -->
                <aside class="summary-card card">
                    <h2>Order summary</h2>
                    <div class="row"><span>Items</span><span th:text="${cart.items.size()}">0</span></div>
                    <div class="row"><span>Subtotal</span><span th:text="${#numbers.formatDecimal(cart.subtotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
                    <div class="row"><span>Tax (8%)</span><span th:text="${#numbers.formatDecimal(cart.tax,1,'COMMA',2,'POINT')}">$0.00</span></div>
                    <div class="row total"><span>Total</span><span th:text="${#numbers.formatDecimal(cart.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
                    <a class="btn-checkout" th:href="@{/order/checkout}">
                        <i class="fa-solid fa-credit-card"></i> Proceed to checkout
                    </a>
                </aside>
            </div>
        </div>
    </div>

    <!-- Saved tab -->
    <div id="saved-tab-content" class="tab-content">
        <div th:if="${cart != null and cart.savedForLater != null and !#lists.isEmpty(cart.savedForLater)}">
            <main class="cart-items-container">
                <div class="cart-header">
                    <h1>Saved for later</h1>
                    <a href="#">Deselect all items</a>
                </div>

                <div th:each="it : ${cart.savedForLater}" class="cart-item-card">
                    <div class="item-image">
                        <input type="checkbox" checked/>
                        <img th:src="${#strings.isEmpty(it.imageUrl) ? '/images/chilli%20powder.jpeg' : it.imageUrl}" alt="Product Image"/>
                    </div>

                    <div class="item-details">
                        <h3 th:text="${it.name}">Product name</h3>

                        <div class="small-muted" th:if="${it.description != null}" th:text="${it.description}">
                            Product short description.
                        </div>
                        <span class="weight-pill" th:if="${it.weightGrams != null}"
                              th:text="${it.weightGrams} + ' g'">500 g</span>

                        <div class="item-stock">In Stock</div>

                        <div class="item-actions-toolbar">
                            <form th:action="@{/cart/moveToCart}" method="post" style="display:inline">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="productId" th:value="${it.productId}"/>
                                <button type="submit" class="btn-action">Move to cart</button>
                            </form>
                        </div>
                    </div>

                    <div class="item-price">
                        $ <span th:text="${#numbers.formatDecimal(it.price,1,'COMMA',2,'POINT')}">0.00</span>
                    </div>
                </div>
            </main>
        </div>
    </div>

</div>

<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>About Spice Jar</h3>
            <p>Bringing the world's finest spices to your kitchen. Quality, aroma, and flavor guaranteed in every jar.</p>
        </div>
        <div class="footer-column">
            <h3>Quick Links</h3>
            <ul>
                <li><a th:href="@{/menu}">Menu</a></li>
                <li><a th:href="@{/about}">About Us</a></li>
                <li><a th:href="@{/contact}">Contact</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Connect With Us</h3>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 The Spice Jar. All rights reserved.</p>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // qty buttons -> submit form
        document.querySelectorAll('.qty-btn-minus').forEach(btn=>{
            btn.addEventListener('click',()=>{
                const id = btn.dataset.productId;
                const input = document.getElementById(`qty-input-${id}`);
                const val = Math.max(0, parseInt(input.value||'1',10)-1);
                input.value = val;
                input.closest('form').submit();
            });
        });
        document.querySelectorAll('.qty-btn-plus').forEach(btn=>{
            btn.addEventListener('click',()=>{
                const id = btn.dataset.productId;
                const input = document.getElementById(`qty-input-${id}`);
                input.value = (parseInt(input.value||'0',10)+1);
                input.closest('form').submit();
            });
        });

        // debounce manual change
        document.querySelectorAll('.qty-input').forEach(input=>{
            let t;
            input.addEventListener('change',()=>{
                clearTimeout(t);
                t = setTimeout(()=> input.closest('form').submit(), 400);
            });
        });

        // tabs
        const links = document.querySelectorAll('.tab-link');
        const cartCount = document.getElementById('cartCountSpan')?.textContent?.trim() || '0';
        const savedCount = document.getElementById('savedCountSpan')?.textContent?.trim() || '0';
        function show(tab){
            document.getElementById('cart-tab-content').classList.toggle('active', tab==='cart');
            document.getElementById('saved-tab-content').classList.toggle('active', tab==='saved');
            links.forEach(l=>l.classList.toggle('active', l.dataset.tab=== (tab==='cart'?'cart-tab':'saved-tab')));
        }
        links.forEach(l=>l.addEventListener('click',e=>{
            e.preventDefault();
            show(l.dataset.tab==='cart-tab'?'cart':'saved');
        }));
        if (cartCount !== '0') show('cart'); else if (savedCount !== '0') show('saved');
    });
</script>

</body>
</html>