<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${product.name} + ' â€¢ The Spice Jar'">Product</title>

    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root { --green:#218838; --accent:#b7410e; --dark:#111; }
        * { box-sizing: border-box; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f0f8f0; color:#222; }
        .navbar{ background:#fff; padding:6px 6%; box-shadow:0 2px 6px rgba(0,0,0,.05);
            display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1000; height:60px; }
        .brand-logo{display:flex; align-items:center; gap:8px; text-decoration:none; color:var(--green); font-weight:700; font-size:20px}
        .brand-logo video{width:36px; height:auto; border-radius:4px}
        .container{padding:28px 6%; max-width:1100px; margin:0 auto;}
        .grid{display:grid; grid-template-columns: 480px 1fr; gap:24px}
        @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
        .card{background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); padding:18px}
        .imgbox img{width:100%; height:auto; border-radius:12px; object-fit:cover}
        .title{margin:0 0 6px; color:#111; font-size:26px; font-weight:800}

        /* Nav search (kept for consistency) */
        .nav-search{flex:1; max-width:520px; display:flex; align-items:center; gap:8px}
        .nav-search input{
            width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:999px;
            background:#fff; font-size:14px; outline:none;
        }
        .nav-search button{
            border:none; border-radius:999px; padding:9px 12px; background:var(--green); color:#fff; cursor:pointer;
        }
        .nav-search button:hover{background:var(--accent);}

        .nav-links{display:flex; align-items:center; gap:18px; margin-left:auto;}
        .nav-links a{text-decoration:none; color:#333; font-weight:500; font-size:15px}
        .nav-links a:hover{color:#218838}

        .dropdown{position:relative}
        .dropdown-toggle{background:none; border:none; cursor:pointer; font-size:15px; color:#333; display:flex; align-items:center; gap:6px}
        .dropdown-menu{display:none; position:absolute; right:0; top:100%; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.1); border-radius:6px; overflow:hidden; min-width:180px}
        .dropdown:hover .dropdown-menu{display:block}
        .dropdown-menu a, .dropdown-menu span{display:block; padding:10px 16px; text-decoration:none; color:#333; white-space:nowrap}
        .dropdown-menu a:hover{background:#f4f4f4}

        /* Cart badge */
        .cart-icon-container { position: relative; display: inline-block; }
        .cart-count-badge {
            position: absolute; top: -8px; right: -8px; background-color: var(--accent);
            color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; text-align: center;
        }

        .muted{color:#666}
        .price{font-size:22px; font-weight:800; margin:10px 0}
        .choices{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0}
        .choice{border:1px solid #d7eadf; background:#eef6f0; color:#1e7e34; padding:6px 10px; border-radius:999px; font-weight:700; cursor:pointer}
        .choice[aria-pressed="true"]{outline:2px solid #1e7e34}
        .btn{border:none; border-radius:10px; padding:12px 16px; font-weight:800; cursor:pointer}
        .btn-primary{background:var(--green); color:#fff}
        .btn-primary:hover{background:var(--accent)}
        .pill{background:#eef6f0; border:1px solid #d7eadf; color:#1e7e34; padding:4px 10px; border-radius:999px; font-weight:600; font-size:13px}
        .stars{color:#f59e0b; display:inline-flex; gap:2px; align-items:center}
        .section-title{font-size:18px; margin:18px 0 10px; font-weight:800}
        .review{border-top:1px dashed #e5efe5; padding:12px 0}
        .review h4{margin:4px 0 6px; font-size:15px}
        .review .meta{font-size:12px; color:#666}
        .label{display:block; font-size:13px; color:#444; margin:6px 0 6px}
        input[type="text"], textarea, select { width:100%; padding:11px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:#fff; }
        textarea{min-height:110px}
        .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
        .crumbs{font-size:13px; margin-bottom:12px; color:#555}
        .crumbs a{color:#218838; text-decoration:none}
        .section{padding:30px 6%;background:#fff}
        .section h2{color:#218838;text-align:center;margin:0 0 16px}
        .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}

        /* Footer */
        .site-footer{background:#222; color:#fff; padding:40px 6%; margin-top:40px}
        .footer-container{display:flex; flex-wrap:wrap; justify-content:space-between; gap:30px; margin-bottom:30px}
        .footer-column{flex:1; min-width:220px}
        .footer-column h3{color:#fff; margin-bottom:15px; font-weight:600; border-bottom:2px solid var(--green); padding-bottom:8px; display:inline-block}
        .footer-column p{line-height:1.6; font-size:14px}
        .footer-column ul{list-style:none; padding:0; margin:0}
        .footer-column ul li a{text-decoration:none; color:#ccc; display:block; padding:5px 0; font-size:14px; transition:color .3s}
        .footer-column ul li a:hover{color:#fff}
        .footer-bottom{text-align:center; padding-top:20px; border-top:1px solid #444; font-size:14px}

        @media (max-width: 900px){ .nav-links{display:none} }
        .social-links a { color: #ccc; text-decoration: none; font-size: 20px; margin-right: 15px; transition: color 0.3s; }
        .social-links a:hover { color: var(--green); }
        .footer-bottom { text-align: center; padding-top: 20px; border-top: 1px solid #444; font-size: 14px; }
        @media (max-width: 768px) { .footer-container { flex-direction: column; text-align: center; } .footer-column { margin-bottom: 20px; } }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <!-- Compact search -> /menu?q=... -->
    <form class="nav-search" role="search" onsubmit="return false;">
        <input id="nav-q" type="search" placeholder="Search spicesâ€¦" aria-label="Search" th:value="${q}">
        <button id="nav-search-btn" type="button" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <!-- Account -->
        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>
                <span th:if="${session.USER != null}">
          Welcome, <strong th:text="${session.USER.firstName}">User</strong>
        </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>


<main class="container" th:with="p=${product}">
    <div class="crumbs">
        <a th:href="@{/menu}">Menu</a> &nbsp;/&nbsp; <span th:text="${p.name}">Product</span>
    </div>

    <section class="grid">
        <!-- Left: image -->
        <div class="card imgbox">
            <img th:src="${#strings.isEmpty(p.imageUrl) ? '/images/chilli%20powder.jpeg' : p.imageUrl}"
                 alt="Product image"/>
        </div>

        <!-- Right: details -->
        <div class="card">
            <h1 class="title" th:text="${p.name}">Product Name</h1>

            <!-- Rating summary with half-star logic -->
            <div class="row" aria-label="Rating summary"
                 th:with="avg=${avgRating} ?: 0,
                          full=${T(java.lang.Math).floor(avg)},
                          rem=${avg - full},
                          half=${rem >= 0.25 and rem < 0.75},
                          roundUp=${rem >= 0.75},
                          full2=${full + (roundUp ? 1 : 0)},
                          empty=${5 - full2 - (half ? 1 : 0)}">
                <div class="stars">
                    <i class="fa-solid fa-star" th:each="i : ${#numbers.sequence(1, full)}" style="font-size:18px"></i>
                    <i class="fa-solid fa-star-half-stroke" th:if="${!roundUp and half}" style="font-size:18px"></i>
                    <i class="fa-regular fa-star" th:each="i : ${#numbers.sequence(1, empty)}" style="font-size:18px"></i>
                </div>
                <div class="muted">
                    <span th:text="${#numbers.formatDecimal(avgRating,1,'COMMA',1,'POINT')}">0.0</span>/5
                    Â· <span th:text="${reviewCount}">0</span> reviews
                </div>
            </div>

            <p class="muted" th:text="${p.description}">Descriptionâ€¦</p>

            <!-- Price (from variants if present) -->
            <div class="price"
                 th:if="${p.variants != null and !p.variants.isEmpty()}"
                 th:text="${'From $ ' + #numbers.formatDecimal(p.variants.?min(v -> v.price).![price][0], 1, 'COMMA', 2, 'POINT')}">
                From $ 0.00
            </div>
            <div class="price"
                 th:if="${p.variants == null or p.variants.isEmpty()}"
                 th:text="${'$ ' + #numbers.formatDecimal(p.price,1,'COMMA',2,'POINT')}">
                $ 0.00
            </div>

            <!-- Variant choices -->
            <div class="choices" th:if="${p.variants != null and !p.variants.isEmpty()}">
                <button class="choice"
                        th:each="v,vi : ${p.variants}"
                        th:attr="data-variant-id=${v.id}, data-price=${v.price}, data-weight=${v.weight}"
                        th:aria-pressed="${vi.index == 0} ? true : false"
                        th:text="${#numbers.formatInteger(v.weight,1,'COMMA') + ' g'}">100 g</button>
            </div>

            <!-- Base pills -->
            <div class="row" style="margin:8px 0">
                <span class="pill" th:if="${p.weight != null}"
                      th:text="${#numbers.formatInteger(p.weight,1,'COMMA') + ' g'}">250 g</span>
                <span class="pill" th:if="${p.category != null}" th:text="${p.category.name}">Category</span>
            </div>

            <!-- Add to cart -->
            <form th:action="@{/cart/add}" method="post" class="row" style="margin-top:10px">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="productId" th:value="${p.id}"/>
                <input type="hidden" name="variantId" value=""/>
                <input type="number" name="qty" min="1" value="1" style="width:90px; padding:10px; border:1px solid #ddd; border-radius:8px"/>
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-cart-plus"></i>&nbsp;Add to cart</button>
            </form>
        </div>
    </section>

    <!-- Reviews list -->
    <section class="card" style="margin-top:20px">
        <div class="section-title">Customer reviews</div>

        <div th:if="${#lists.isEmpty(reviews)}" class="muted">No reviews yet.</div>

        <div th:each="r : ${reviews}" class="review">
            <div class="row">
                <div class="stars" th:with="n=${r.rating}">
                    <i class="fa-solid fa-star" th:each="i:${#numbers.sequence(1, n)}"></i>
                    <i class="fa-regular fa-star" th:each="i:${#numbers.sequence(1, 5 - n)}"></i>
                </div>
                <div class="meta">
                    by <strong th:text="${r.user != null ? r.user.firstName : 'User'}">User</strong> Â·
                    <span th:text="${#temporals.format(r.createdAt,'MMM d, yyyy')}">Oct 1, 2025</span>
                </div>
            </div>
            <h4 th:text="${r.title}">Great quality!</h4>
            <p th:text="${r.comment}">Loved the aromaâ€¦</p>
        </div>
    </section>

    <!-- Write a review -->
    <section class="card" style="margin-top:20px">
        <div class="section-title">Write a review</div>

        <div th:if="${!canReview}" class="muted">
          <span th:if="${session.USER == null}">
            Please <a th:href="@{/login}">log in</a> to write a review.
          </span>
            <span th:if="${session.USER != null}">
            Youâ€™ve already reviewed this product. Thank you!
          </span>
        </div>

        <form th:if="${canReview}" th:action="@{/products/{id}/reviews(id=${product.id})}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <label class="label">Rating</label>
            <select name="rating" required>
                <option value="5">â˜…â˜…â˜…â˜…â˜… â€“ Excellent</option>
                <option value="4">â˜…â˜…â˜…â˜…â˜† â€“ Good</option>
                <option value="3">â˜…â˜…â˜…â˜†â˜† â€“ Okay</option>
                <option value="2">â˜…â˜…â˜†â˜†â˜† â€“ Poor</option>
                <option value="1">â˜…â˜†â˜†â˜†â˜† â€“ Bad</option>
            </select>

            <label class="label">Title</label>
            <input type="text" name="title" maxlength="120" required/>

            <label class="label">Your review</label>
            <textarea name="comment" maxlength="4000" required></textarea>

            <div class="row" style="margin-top:10px">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-paper-plane"></i>&nbsp;Submit review</button>
            </div>
        </form>
    </section>
</main>

<!-- Footer -->
<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>About Spice Jar</h3>
            <p>Bringing the world's finest spices to your kitchen. Quality, aroma, and flavor guaranteed in every jar.</p>
        </div>
        <div class="footer-column">
            <h3>Quick Links</h3>
            <ul>
                <li><a th:href="@{/menu}">Menu</a></li>
                <li><a th:href="@{/about}">About Us</a></li>
                <li><a th:href="@{/contact}">Contact</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Connect With Us</h3>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 The Spice Jar. All rights reserved.</p>
    </div>
</footer>

<script>

    (function(){
        // variant chooser on details page
        const choices = document.querySelectorAll('.choice');
        const variantInput = document.querySelector('input[name="variantId"]');
        const priceEl = document.querySelector('.price');

        function fmt(n){ return '$ ' + (Number(n)||0).toFixed(2); }

        function select(btn){
            choices.forEach(b=>b.setAttribute('aria-pressed','false'));
            btn.setAttribute('aria-pressed','true');
            if (variantInput) variantInput.value = btn.getAttribute('data-variant-id') || '';
            const price = btn.getAttribute('data-price');
            if (price && priceEl) priceEl.textContent = fmt(price);
        }

        if (choices.length){
            const first = document.querySelector('.choice[aria-pressed="true"]') || choices[0];
            if (first) select(first);
        }

        document.addEventListener('click', (e)=>{
            const btn = e.target.closest('.choice'); if (!btn) return;
            select(btn);
        });

        // nav search -> /menu?q=...
        const qInput = document.getElementById('nav-q');
        const goSearch = () => {
            const q = (qInput?.value || '').trim();
            const url = q ? `/menu?q=${encodeURIComponent(q)}` : '/menu';
            window.location.href = url;
        };
        document.getElementById('nav-search-btn')?.addEventListener('click', goSearch);
        qInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); goSearch(); }});
    })();


    (function () {
        // ... keep your existing code ...

        // === Add-to-cart (AJAX) for the product detail page ===
        const cartBadge = document.getElementById('lblCartCount');
        const cartForm  = document.querySelector('form[action$="/cart/add"]');

        function toast(msg){
            const t = document.createElement('div');
            t.textContent = msg;
            t.style.position='fixed';
            t.style.right='20px';
            t.style.bottom='20px';
            t.style.background='#218838';
            t.style.color='#fff';
            t.style.padding='10px 14px';
            t.style.borderRadius='12px';
            t.style.boxShadow='0 6px 16px rgba(0,0,0,.2)';
            t.style.zIndex='2000';
            document.body.appendChild(t);
            setTimeout(()=>t.remove(), 1400);
        }

        if (cartForm) {
            cartForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // stay on the same page
                const data = new URLSearchParams(new FormData(cartForm));
                const csrf = cartForm.querySelector('input[name="_csrf"]')?.value;

                try {
                    const res = await fetch(cartForm.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded',
                            ...(csrf ? { 'X-CSRF-TOKEN': csrf } : {})
                        },
                        body: data
                    });

                    // If the server still sends HTML (not JSON), don't crash
                    const text = await res.text();
                    let out;
                    try { out = JSON.parse(text); } catch { out = null; }

                    if (out && out.status === 'success') {
                        if (cartBadge) cartBadge.textContent = out.cartCount ?? 0;
                        toast('Added to cart ðŸ›’');
                    } else {
                        // fallback if server returned a redirect/html
                        toast(out?.message || 'Added to cart');
                        // best effort: bump badge if possible
                        if (cartBadge && out?.cartCount != null) cartBadge.textContent = out.cartCount;
                    }
                } catch (err) {
                    console.error('Add to cart error:', err);
                    toast('Error adding to cart');
                }
            });
        }
    })();
</script>

</body>
</html>
