<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Order Details • The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <style>
        :root{
            --green:#218838;
            --accent:#b7410e;
            --bg:#f6fbf6;
            --card:#ffffff;
            --shadow:0 10px 30px rgba(0,0,0,.08);
        }
        *{ box-sizing:border-box; }

        body{
            margin:0;
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:radial-gradient(circle at top left,#e0f5e5 0,#f6fbf6 40%,#f0f8f0 100%);
            color:#111;
        }

        /* Navbar */
        .navbar{
            background:#fff;
            padding:6px 6%;
            box-shadow:0 2px 6px rgba(0,0,0,.05);
            display:flex;
            justify-content:space-between;
            align-items:center;
            position:sticky;
            top:0;
            z-index:1000;
            height:60px;
        }
        .brand-logo{
            display:flex;
            align-items:center;
            gap:8px;
            text-decoration:none;
            color:var(--green);
            font-weight:700;
            font-size:20px;
        }
        .brand-logo video{
            width:36px;
            height:auto;
            border-radius:4px;
        }

        .nav-links{
            display:flex;
            align-items:center;
            gap:18px;
        }
        .nav-links a{
            text-decoration:none;
            color:#333;
            font-weight:500;
            font-size:15px;
        }
        .nav-links a:hover{ color:var(--green); }

        .dropdown{ position:relative; }
        .dropdown-toggle{
            background:none;
            border:none;
            cursor:pointer;
            font-size:15px;
            color:#333;
            display:flex;
            align-items:center;
            gap:6px;
        }
        .dropdown-menu{
            display:none;
            position:absolute;
            right:0;
            top:100%;
            background:#fff;
            box-shadow:0 4px 10px rgba(0,0,0,.1);
            border-radius:6px;
            overflow:hidden;
            min-width:180px;
        }
        .dropdown:hover .dropdown-menu{ display:block; }

        .cart-icon-container{
            position:relative;
            display:inline-block;
        }
        .cart-count-badge{
            position:absolute;
            top:-8px;
            right:-8px;
            background-color:var(--accent);
            color:#fff;
            border-radius:50%;
            padding:2px 6px;
            font-size:12px;
            font-weight:bold;
            display:flex;
            align-items:center;
            justify-content:center;
            min-width:20px;
            height:20px;
        }

        .wrap{
            max-width:900px;
            margin:26px auto 40px;
            padding:0 6%;
        }
        h1{
            margin:0 0 6px;
            font-size:26px;
            color:#333;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .subtitle{
            margin:0 0 16px;
            font-size:13px;
            color:#6b7280;
        }

        .card{
            background:var(--card);
            border-radius:16px;
            box-shadow:var(--shadow);
            padding:22px;
        }

        .grid{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:14px;
            margin-top:8px;
        }
        @media(max-width:800px){
            .grid{ grid-template-columns:1fr; }
        }

        .info{
            background:#fafafa;
            border:1px solid #eee;
            border-radius:12px;
            padding:14px;
        }
        .label{
            font-size:12px;
            letter-spacing:.04em;
            color:#64748b;
            font-weight:800;
        }
        .val{
            font-weight:800;
            margin-top:6px;
            color:#111;
        }

        .pill{
            padding:6px 10px;
            border-radius:999px;
            font-size:12px;
            font-weight:700;
            display:inline-block;
        }
        .pill.NEW{ background:#f0f0f0; color:#4a4a4a; }
        .pill.PAID{ background:#e6f7e9; color:#137a2a; }
        .pill.SHIPPED{ background:#e0f2fe; color:#0c5678; }
        .pill.DELIVERED{ background:#dff0d8; color:#4f8a10; }
        .pill.PENDING_PAYMENT{ background:#fff7e6; color:#92400e; }
        .pill.RETURN_REQUESTED{ background:#fff5f5; color:#b91c1c; }
        .pill.RETURNED{ background:#fee2e2; color:#7f1d1d; }

        table{
            width:100%;
            border-collapse:collapse;
            margin-top:18px;
        }
        thead th{
            background:#f9faf9;
            font-weight:800;
        }
        th,td{
            padding:12px;
            border-bottom:1px solid #eee;
            text-align:left;
            font-size:14px;
        }
        .it-img{
            width:60px;
            height:60px;
            border-radius:6px;
            object-fit:cover;
        }

        .totals{
            margin-top:16px;
            background:#fff;
            border-radius:12px;
            border:1px solid #eee;
        }
        .totals-row{
            display:flex;
            justify-content:space-between;
            padding:10px 14px;
            font-size:14px;
        }
        .totals-row.total{
            font-weight:900;
            border-top:1px dashed #e5e7eb;
            margin-top:4px;
        }

        .ship-qr-bar{
            display:grid;
            grid-template-columns:2fr 1fr 1fr;
            gap:18px;
            margin-top:20px;
        }
        @media(max-width:900px){
            .ship-qr-bar{
                grid-template-columns:1fr;
            }
        }

        .card-lite{
            background:#fafafa;
            border-radius:14px;
            border:1px solid #e5e7eb;
            padding:14px;
        }
        .title-small{
            font-weight:800;
            margin:0 0 10px;
            color:#333;
            display:flex;
            align-items:center;
            gap:8px;
            font-size:14px;
        }

        .code-box{
            border:1px dashed #e5e7eb;
            background:#fff;
            border-radius:12px;
            height:210px;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
        }

        .actions{
            margin-top:22px;
            display:flex;
            gap:12px;
            flex-wrap:wrap;
        }
        .btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 16px;
            border:none;
            border-radius:999px;
            cursor:pointer;
            font-weight:600;
            font-size:14px;
            text-decoration:none;
            transition:background-color .15s ease, transform .05s ease;
        }
        .btn:hover{ transform:translateY(-1px); opacity:.95; }

        .btn.track{ background:#2563eb; color:#fff; }
        .btn.cancel{ background:#dc2626; color:#fff; }
        .btn.return{ background:#f59e0b; color:#fff; }
        .btn.pay{ background:#16a34a; color:#fff; }
        .btn.mail{ background:#111; color:#fff; }
        .btn.invoice{
            background:#ffffff;
            color:#111827;
            border:1px solid #e5e7eb;
        }

        .site-footer{
            background:#222;
            color:#ccc;
            padding:40px 6%;
            margin-top:40px;
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <div class="dropdown">
            <button class="dropdown-toggle"><i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}"></span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>

                <span th:if="${session.USER != null}">
                    Welcome, <strong th:text="${session.USER.firstName}"></strong>
                </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>

<main class="wrap">

    <h1><i class="fa-solid fa-receipt"></i> Order Details</h1>
    <p class="subtitle">View items, totals, shipping details and refund options</p>

    <div th:if="${msg}"
         style="margin:10px;padding:10px;border-radius:8px;background:#ecfdf5;color:#065f46"
         th:text="${msg}"></div>
    <div th:if="${err}"
         style="margin:10px;padding:10px;border-radius:8px;background:#fef2f2;color:#991b1b"
         th:text="${err}"></div>

    <section class="card">

        <!-- SUMMARY -->
        <div class="grid">
            <div class="info">
                <div class="label">ORDER ID</div>
                <div class="val">#<span th:text="${order.id}"></span></div>
            </div>
            <div class="info">
                <div class="label">CONFIRMATION #</div>
                <div class="val" th:text="${order.confirmationNumber}"></div>
            </div>
            <div class="info">
                <div class="label">STATUS</div>
                <div class="val">
                    <span class="pill" th:classappend="${order.status}" th:text="${order.status}"></span>
                </div>
            </div>
            <div class="info">
                <div class="label">PLACED ON</div>
                <div class="val" th:text="${#temporals.format(order.createdAt,'MMM d, yyyy • h:mm a')}"></div>
            </div>
        </div>

        <!-- ITEMS TABLE -->
        <table>
            <thead>
            <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Line Total</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="it : ${order.items}">
                <td>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <img th:src="${#strings.isEmpty(it.imageUrl) ? '/images/chilli%20powder.jpeg' : it.imageUrl}"
                             class="it-img"/>
                        <span th:text="${it.productName}"></span>
                    </div>
                </td>

                <td th:text="${it.quantity}"></td>
                <td th:text="${#numbers.formatDecimal(it.price,1,'COMMA',2,'POINT')}"></td>
                <td th:text="${#numbers.formatDecimal(it.lineTotal,1,'COMMA',2,'POINT')}"></td>

                <td>

                    <!-- RETURN BADGES (null-safe) -->
                    <span th:if="${it.returnRequested == true}" class="pill RETURN_REQUESTED">
                        Return Requested
                    </span>
                    <span th:if="${it.returned == true}" class="pill RETURNED">
                        Returned
                    </span>

                    <!-- RETURN BUTTON (null-safe) -->
                    <form th:if="${#lists.contains({'DELIVERED','SHIPPED','PAID'}, order.status)
                           and (it.returnRequested == null or it.returnRequested == false)
                           and (it.returned == null or it.returned == false)}"
                          th:action="@{/order/{orderId}/returnItem/{itemId}(orderId=${order.id}, itemId=${it.id})}"
                          method="post"
                          style="display:inline-block;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn return" type="submit">
                            <i class="fa-solid fa-rotate-left"></i> Return Item
                        </button>
                    </form>

                </td>
            </tr>
            </tbody>
        </table>

        <!-- TOTALS -->
        <div class="totals">
            <div class="totals-row">
                <div>Subtotal</div>
                <div th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}"></div>
            </div>
            <div class="totals-row">
                <div>Tax</div>
                <div th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}"></div>
            </div>
            <div class="totals-row total">
                <div>Total Paid</div>
                <div th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}"></div>
            </div>
        </div>

        <!-- REFUND HISTORY -->
        <div th:if="${refunds != null and !#lists.isEmpty(refunds)}"
             style="margin-top:18px;background:#fafafa;border-radius:12px;border:1px solid #eee;padding:14px;">
            <div style="font-weight:800;font-size:14px;margin-bottom:8px;">
                <i class="fa-solid fa-rotate-left"></i> Refund History
            </div>

            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                <tr>
                    <th style="text-align:left;padding:6px 8px;">Date</th>
                    <th style="text-align:left;padding:6px 8px;">Method</th>
                    <th style="text-align:right;padding:6px 8px;">Amount</th>
                    <th style="text-align:left;padding:6px 8px;">Reason</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r : ${refunds}">
                    <td style="padding:6px 8px;"
                        th:text="${#temporals.format(r.refundedAt != null ? r.refundedAt : r.createdAt,'MMM d, yyyy • h:mm a')}">
                    </td>
                    <td th:text="${r.displayName != null ? r.displayName : r.provider}"></td>
                    <td style="padding:6px 8px;text-align:right;"
                        th:text="${#numbers.formatDecimal(r.amount,1,'COMMA',2,'POINT')}">
                    </td>
                    <td style="padding:6px 8px;"
                        th:text="${r.refundReason != null ? r.refundReason : 'Refund'}">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- SHIPPING + QR + BARCODE -->
        <div class="ship-qr-bar">
            <div class="card-lite">
                <h3 class="title-small"><i class="fa-solid fa-location-dot"></i> Shipping address</h3>
                <div>
                    <div th:text="${order.customerName}"></div>
                    <div th:text="${order.phone}"></div>
                    <div th:text="${order.street}"></div>
                    <div>
                        <span th:text="${order.city}"></span>,
                        <span th:text="${order.state}"></span>
                        <span th:text="${order.zip}"></span>
                    </div>
                    <div th:text="${order.country}"></div>
                </div>
            </div>

            <div class="card-lite">
                <h3 class="title-small"><i class="fa-solid fa-qrcode"></i> QR Shipping</h3>
                <div id="qrBox" class="code-box"></div>
                <button id="btnDownloadQr" class="btn invoice" style="margin-top:10px;">
                    <i class="fa-solid fa-download"></i> Download QR
                </button>
            </div>

            <div class="card-lite">
                <h3 class="title-small"><i class="fa-solid fa-barcode"></i> Barcode</h3>
                <div class="code-box" style="height:150px;">
                    <svg id="barcodeSvg"></svg>
                </div>
                <button id="btnDownloadBarcode" class="btn invoice" style="margin-top:10px;">
                    <i class="fa-solid fa-download"></i> Download Barcode
                </button>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="actions">
            <a class="btn track" th:href="@{/orders/{id}/track(id=${order.id})}">
                <i class="fa-solid fa-truck"></i> Track Package
            </a>

            <a class="btn invoice" th:href="@{/orders/{id}/invoice(id=${order.id})}" target="_blank">
                <i class="fa-solid fa-file-invoice"></i> Download Invoice
            </a>

            <a class="btn pay" th:if="${order.status == 'PENDING_PAYMENT'}"
               th:href="@{/payment/checkout(orderId=${order.id})}">
                <i class="fa-solid fa-credit-card"></i> Pay Now
            </a>

            <form th:if="${order.email != null}" th:action="@{/orders/{id}/email(id=${order.id})}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn mail"><i class="fa-solid fa-envelope"></i> Resend Receipt</button>
            </form>

            <form th:if="${order.status == 'PENDING_PAYMENT' or order.status == 'PAID'}"
                  th:action="@{/orders/{id}/cancel(id=${order.id})}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn cancel"><i class="fa-solid fa-ban"></i> Cancel Order</button>
            </form>

            <!-- Return entire order -->
            <form th:if="${#lists.contains({'DELIVERED','SHIPPED','PAID'}, order.status)
                   and order.createdAt != null
                   and #temporals.createNow().minusDays(30).isBefore(order.createdAt)}"
                  th:action="@{/order/{orderId}/return(orderId=${order.id})}"
                  method="post"
                  style="display:inline-block;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn return" type="submit">
                    <i class="fa-solid fa-rotate-left"></i> Return Order
                </button>
            </form>
        </div>

    </section>
</main>

<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>About Spice Jar</h3>
            <p>The world's finest spices delivered to your kitchen.</p>
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.6/JsBarcode.all.min.js"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const orderId = /*[[${order.id}]]*/ '';
        const qrBox = document.getElementById('qrBox');

        new QRCode(qrBox, {
            text: "Order " + orderId,
            width: 200,
            height: 200
        });

        const barcodeSvg = document.getElementById('barcodeSvg');
        JsBarcode(barcodeSvg, String(orderId), {format: "CODE128", width: 2, height: 60});

        document.getElementById('btnDownloadQr').addEventListener('click', () => {
            const canvas = qrBox.querySelector('canvas');
            const url = canvas.toDataURL("image/png");
            const a = document.createElement("a");
            a.href = url;
            a.download = "QR-" + orderId + ".png";
            a.click();
        });

        document.getElementById('btnDownloadBarcode').addEventListener('click', () => {
            const blob = new Blob([barcodeSvg.outerHTML], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "Barcode-" + orderId + ".svg";
            a.click();
        });
    });
</script>

</body>
</html>
