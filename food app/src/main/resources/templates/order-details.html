<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Order Details • The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root{ --green:#22c55e; --accent:#b7410e; --bg:#f6fbf6; }
        *{ box-sizing:border-box }
        body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:#111 }
        .wrap{max-width:900px;margin:26px auto;padding:0 6%}
        .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px}

        h1{margin:0 0 12px;font-size:28px;color:#333}

        .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
        @media(max-width:800px){.grid{grid-template-columns:1fr}}

        .info{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:14px}
        .label{font-size:12px;letter-spacing:.04em;color:#64748b;font-weight:800}
        .val{font-weight:800;margin-top:6px}

        table{width:100%;border-collapse:collapse;margin-top:16px}
        th,td{padding:12px;border-bottom:1px solid #eee;text-align:left}
        thead th{background:#f9faf9;font-weight:800}

        .totals{margin-top:14px;background:#fff;border-radius:12px;border:1px solid #eee}
        .row{display:flex;justify-content:space-between;padding:10px 14px}
        .row.total{font-weight:900}

        .actions{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap}
        .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border:none;border-radius:8px;
            cursor:pointer;font-weight:600;font-size:14px;text-decoration:none}
        .btn.track{background:#2563eb;color:#fff}
        .btn.cancel{background:#dc2626;color:#fff}
        .btn.return{background:#f59e0b;color:#fff}
        .btn.pay{background:#16a34a;color:#fff} /* NEW: Pay now */
        .btn:hover{opacity:.9}

        .status{padding:4px 10px;border-radius:8px;font-weight:700;font-size:14px;display:inline-block}
        .status.paid{background-color:var(--green);color:#fff}
        .status.pending{background-color:#ffc107;color:#000}
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:24px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <!-- Categories -->
        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fa-solid fa-list"></i> Categories
            </button>
            <div class="dropdown-menu">
                <a th:each="c : ${categories}"
                   th:href="@{/category/{id}(id=${c.id})}"
                   th:text="${c.name}">Category</a>
            </div>
        </div>

        <!-- Account -->
        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fas fa-user"></i>  Account
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>
                <span th:if="${session.USER != null}">
                 Welcome, <span th:text="${session.USER.firstName}">user</span>
                </span>
                <a  th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>


<main class="wrap">
    <h1><i class="fa-solid fa-receipt"></i> Order Details</h1>

    <section class="card">
        <div class="grid">
            <div class="info">
                <div class="label">ORDER ID</div>
                <div class="val">#<span th:text="${order.id}">123</span></div>
            </div>
            <div class="info">
                <div class="label">CONFIRMATION #</div>
                <div class="val" th:text="${order.confirmationNumber}">TSJ-20250917-ABC123</div>
            </div>
            <div class="info">
                <div class="label">STATUS</div>
                <div class="val">
                  <span th:class="|status ${order.status.toLowerCase()}|"
                        th:text="${order.status}">Pending</span>
                </div>
            </div>
            <div class="info">
                <div class="label">PLACED ON</div>
                <div class="val" th:text="${#temporals.format(order.createdAt,'MMM d, yyyy • h:mm a')}">
                    Aug 29, 2025
                </div>
            </div>
        </div>

        <table>
            <thead>
            <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Line Total</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="it : ${order.items}">
                <td>
                    <div style="display:flex;align-items:center;gap:10px">
                        <img th:src="${#strings.isEmpty(it.imageUrl) ? '/images/chilli%20powder.jpeg' : it.imageUrl}"
                             alt="Product" style="width:60px;height:60px;object-fit:cover;border-radius:6px"/>
                        <span th:text="${it.productName}">Spice</span>
                    </div>
                </td>
                <td th:text="${it.quantity}">1</td>
                <td th:text="${#numbers.formatDecimal(it.price,1,'COMMA',2,'POINT')}">$0.00</td>
                <td th:text="${#numbers.formatDecimal(it.price.multiply(new java.math.BigDecimal(it.quantity)),1,'COMMA',2,'POINT')}">$0.00</td>
                <td>
                    <!-- Per-item return button -->
                    <form
                            th:if="${#lists.contains({'DELIVERED','SHIPPED','PAID'}, order.status)}"
                            th:action="@{/orders/{orderId}/returnItem/{itemId}(orderId=${order.id}, itemId=${it.id})}"
                            method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn return" type="submit">
                            <i class="fa-solid fa-rotate-left"></i> Return Item
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="totals">
            <div class="row">
                <div>Subtotal</div>
                <div th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}">$0.00</div>
            </div>
            <div class="row">
                <div>Tax (8%)</div>
                <div th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}">$0.00</div>
            </div>
            <div class="row total">
                <div>Total Paid</div>
                <div th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">$0.00</div>
            </div>
        </div>

        <!-- Global order-level actions -->
        <div class="actions">
            <a class="btn track" th:href="@{/orders/{id}/track(id=${order.id})}">
                <i class="fa-solid fa-truck"></i> Track Package
            </a>

            <a class="btn invoice" th:href="@{/orders/{id}/invoice(id=${order.id})}" target="_blank">
                <i class="fa-solid fa-file-invoice"></i> Download Invoice
            </a>

            <!-- NEW: Pay now button for pending payment -->
            <a class="btn pay"
               th:if="${order.status == 'PENDING_PAYMENT'}"
               th:href="@{/payment/checkout(orderId=${order.id})}">
                <i class="fa-solid fa-credit-card"></i> Pay now
            </a>

            <form th:if="${order.status == 'PENDING_PAYMENT' or order.status == 'PENDING_COD' or order.status == 'PAID'}"
                  th:action="@{/orders/{id}/cancel(id=${order.id})}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn cancel" type="submit"><i class="fa-solid fa-ban"></i> Cancel Order</button>
            </form>

            <form
                    th:if="${#lists.contains({'DELIVERED','SHIPPED','PAID'}, order.status)
                        and order.createdAt != null
                        and #temporals.createNow().minusDays(30).isBefore(order.createdAt)}"
                    th:action="@{/orders/{id}/return(id=${order.id})}"
                    method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn return" type="submit">
                    <i class="fa-solid fa-rotate-left"></i> Return Order
                </button>
            </form>
        </div>
    </section>
</main>

<footer class="site-footer">
    <div class="footer-bottom">
        <p>&copy; <span th:text="${T(java.time.Year).now()}">2025</span> The Spice Jar. All rights reserved.</p>
    </div>
</footer>

</body>
</html>
