<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title th:text="${subject}">Your order is confirmed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* keep email styles simple + inline-safe */
        .box{background:#ffffff;border-radius:12px;overflow:hidden}
        .h{background:#22c55e;color:#fff;padding:18px 20px;font-weight:bold}
        .p{padding:20px}
        .btn{background:#22c55e;color:#fff;text-decoration:none;padding:10px 14px;border-radius:8px;display:inline-block}
        .muted{color:#64748b}
        table{border-collapse:collapse;width:100%}
        th,td{padding:6px 0}
        th{color:#334155;text-align:left}
        td.right{text-align:right}
        hr{border:none;border-top:1px solid #eee;margin:16px 0}
        /* Shipping + Code section */
        .ship-qr-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-top:18px}
        @media(max-width:900px){.ship-qr-bar{grid-template-columns:1fr}}
        .card-lite{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
        .title-small{font-weight:800;margin:0 0 10px;color:#333;display:flex;align-items:center;gap:8px}

        .code-box{
            border:1px dashed #e6e6e6;
            background:#fff;
            border-radius:12px;
            height:260px;              /* equal height for both */
            display:flex;
            align-items:center;        /* vertical center */
            justify-content:center;    /* horizontal center */
            padding:10px;
        }
        .code-box canvas, .code-box svg, .code-box img{
            max-width:100%;
            max-height:100%;
            display:block;
        }
        .downloads{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
        .dl{border:1px solid #cce6cc;background:#eaf9ea;color:#14532d;padding:8px 12px;border-radius:8px;font-weight:700;font-size:13px;text-decoration:none;display:inline-flex;gap:8px;align-items:center}
        .dl:hover{filter:brightness(0.98)}

        /* Product image cell */
        .it-img{width:60px;height:60px;border-radius:6px;object-fit:cover}
    </style>
</head>
<body style="margin:0;background:#f7faf7;font-family:Arial,Helvetica,sans-serif;">
<table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="background:#f7faf7;">
    <tr>
        <td align="center" style="padding:24px;">
            <table role="presentation" width="600" cellpadding="0" cellspacing="0" class="box">
                <tr><td class="h">The Spice Jar — Order Confirmation</td></tr>
                <tr>
                    <td class="p">
                        <h1 style="margin:0 0 6px;font-size:20px;color:#111">Thanks for your order!</h1>
                        <p style="margin:0 0 12px;color:#444">
                            Order No # <span th:text="${order.confirmationNumber}">123</span>
                        </p>

                        <p style="margin:0 0 14px;">
                            <!-- Use absolute URLs coming from the service -->
                            <a th:href="${orderUrl}" class="btn">View your order</a>
                            &nbsp;
                            <a th:href="${invoiceUrl}" class="btn" style="background:#111">Download invoice</a>
                        </p>

                        <hr>

                        <table role="presentation">
                            <tr>
                                <th>Item</th>
                                <th class="right">Qty</th>
                                <th class="right">Price</th>
                            </tr>
                            <tr th:each="it : ${order.items}">
                                <td th:text="${it.productName}">Product</td>
                                <td class="right" th:text="${it.quantity}">1</td>
                                <td class="right"
                                    th:text="${#numbers.formatDecimal(it.price.multiply(new java.math.BigDecimal(it.quantity)),1,'COMMA',2,'POINT')}">
                                    $0.00
                                </td>
                            </tr>
                        </table>

                        <table role="presentation" style="margin-top:10px;">
                            <tr>
                                <td class="muted">Subtotal</td>
                                <td class="right" th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}">$0.00</td>
                            </tr>
                            <tr>
                                <td class="muted">Tax</td>
                                <td class="right" th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}">$0.00</td>
                            </tr>
                            <tr>
                                <td style="font-weight:bold;">Total</td>
                                <td class="right" style="font-weight:bold;"
                                    th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">
                                    $0.00
                                </td>
                            </tr>
                        </table>

                        <div class="ship-qr-bar">
                            <!-- Shipping address -->
                            <div class="card-lite">
                                <h3 class="title-small"><i class="fa-solid fa-location-dot"></i> Shipping address</h3>
                                <div style="white-space:pre-line;line-height:1.5">
                                    <div th:text="${order.customerName}">Customer Name</div>
                                    <div th:text="${order.phone}">5551234567</div>
                                    <div th:text="${order.street}">123 Main St, Apt 206</div>
                                    <div>
                                        <span th:text="${order.city}">Glen Allen</span>,
                                        <span th:text="${order.state}">VA</span>
                                        <span th:text="${order.zip}">23059</span>
                                    </div>
                                    <div th:text="${order.country}">United States</div>
                                </div>
                            </div>

                            <!-- QR -->
                            <div class="card-lite">
                                <h3 class="title-small"><i class="fa-solid fa-qrcode"></i> QR Code</h3>
                                <div class="code-box">
                                    <!-- canvas will be injected -->
                                    <canvas id="qrCanvas" width="512" height="512" style="width:100%;height:100%"></canvas>
                                </div>
                                <div class="downloads">
                                    <a class="dl" id="dlQr"><i class="fa-regular fa-circle-down"></i>Download QR (PNG)</a>
                                </div>
                            </div>

                            <!-- Barcode -->
                            <div class="card-lite">
                                <h3 class="title-small"><i class="fa-solid fa-barcode"></i> Barcode (Code-128)</h3>
                                <div class="code-box">
                                    <!-- SVG target for JsBarcode -->
                                    <svg id="barSvg" viewBox="0 0 600 160" preserveAspectRatio="xMidYMid meet" style="width:100%;height:100%"></svg>
                                </div>
                                <div class="downloads">
                                    <a class="dl" id="dlBar"><i class="fa-regular fa-circle-down"></i>Download Barcode (SVG)</a>
                                </div>
                            </div>
                        </div>

                        <p style="margin:16px 0 0" class="muted">
                            © <span th:text="${year}">2025</span> The Spice Jar
                        </p>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

<!-- QR + Barcode libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

<script>
    // Build a single-line shipping string for codes
    function text(elId, fallback='') {
        const el = document.getElementById(elId);
        return el ? (el.textContent || '').trim() : fallback;
    }

    // Pull Thymeleaf values from DOM (fallbacks keep script harmless if JS runs before hydration)
    const shipName   = (document.querySelector('[th\\:text="${order.customerName}"]')?.innerText) || '';
    const shipPhone  = (document.querySelector('[th\\:text="${order.phone}"]')?.innerText) || '';
    const shipStreet = (document.querySelector('[th\\:text="${order.street}"]')?.innerText) || '';
    const shipCity   = (document.querySelector('[th\\:text="${order.city}"]')?.innerText) || '';
    const shipState  = (document.querySelector('[th\\:text="${order.state}"]')?.innerText) || '';
    const shipZip    = (document.querySelector('[th\\:text="${order.zip}"]')?.innerText) || '';
    const shipCountry= (document.querySelector('[th\\:text="${order.country}"]')?.innerText) || '';
    const orderId    = (document.querySelector('[th\\:text="${order.id}"]')?.innerText) || '';

    const addressLine = [
        shipName,
        shipPhone,
        shipStreet,
        `${shipCity}, ${shipState} ${shipZip}`,
        shipCountry,
        `ORDER:${orderId}`
    ].filter(Boolean).join(' | ');

    /* ---------- QR (on a canvas, scaled to card) ---------- */
    (function makeQR(){
        // qrcode.js renders to a generated <img> or a target element.
        // We'll draw it onto our fixed canvas to control sizing perfectly.
        const tmp = document.createElement('div');
        new QRCode(tmp, { text: addressLine, width: 512, height: 512, correctLevel: QRCode.CorrectLevel.M });
        const img = tmp.querySelector('img') || tmp.querySelector('canvas');
        const qrCanvas = document.getElementById('qrCanvas');
        const ctx = qrCanvas.getContext('2d');
        // Clear and draw scaled
        function draw() {
            const w = qrCanvas.clientWidth;
            const h = qrCanvas.clientHeight;
            qrCanvas.width = w * devicePixelRatio;
            qrCanvas.height = h * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            ctx.clearRect(0,0,w,h);
            // compute size preserving square
            const size = Math.min(w, h);
            const offX = (w - size) / 2;
            const offY = (h - size) / 2;
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(img, offX, offY, size, size);
        }
        // wait for QR image to load (when library renders as img)
        if (img.tagName === 'IMG' && !img.complete) {
            img.onload = draw;
        } else {
            // canvas or already loaded img
            draw();
        }

        // Download PNG
        document.getElementById('dlQr').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `SJ-order-${orderId}-address-qr.png`;
            link.href = qrCanvas.toDataURL('image/png');
            link.click();
        });

        // Redraw on resize for crispness
        let rAF;
        window.addEventListener('resize', () => {
            cancelAnimationFrame(rAF);
            rAF = requestAnimationFrame(draw);
        });
    })();

    /* ---------- BARCODE (Code-128 into SVG) ---------- */
    (function makeBarcode(){
        const svg = document.getElementById('barSvg');
        // JsBarcode draws into the given element; width/height are per-bar, so we tune to look good
        JsBarcode(svg, addressLine, {
            format: "CODE128",
            displayValue: false,
            margin: 16,
            lineColor: "#111",
            width: 2,     // bar width
            height: 80    // bar height (inside our 260px box)
        });

        // Download SVG
        document.getElementById('dlBar').addEventListener('click', () => {
            const serializer = new XMLSerializer();
            const src = serializer.serializeToString(svg);
            const blob = new Blob([src], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SJ-order-${orderId}-address-barcode.svg`;
            a.click();
            URL.revokeObjectURL(url);
        });
    })();
</script>
</body>
</html>
