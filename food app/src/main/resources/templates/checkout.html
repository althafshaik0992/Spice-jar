<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checkout â€¢ The Spice Jar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --green:#218838; --accent:#b7410e; --dark:#111; --bg:#f6fbf6; --card:#fff; }
    * { box-sizing: border-box; }
    body { font-family:'Segoe UI',Tahoma,Arial; margin:0; background:var(--bg); color:#222; }

    /* Navbar (unchanged) */
    .navbar{
      background:#fff; padding:6px 6%;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; z-index:1000; height:60px;
    }
    .brand-logo{display:flex; align-items:center; gap:8px; text-decoration:none; color:var(--green); font-weight:700; font-size:20px}
    .brand-logo video{width:36px; height:auto; border-radius:4px}
    .nav-links{display:flex; align-items:center; gap:18px}
    .nav-links a{text-decoration:none; color:#333; font-weight:500; font-size:15px}
    .nav-links a:hover{color:var(--green)}
    .dropdown{position:relative}
    .dropdown-toggle{background:none; border:none; cursor:pointer; font-size:15px; color:#333; display:flex; align-items:center; gap:6px}
    .dropdown-menu{display:none; position:absolute; right:0; top:100%; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.1); border-radius:6px; overflow:hidden; min-width:180px}
    .dropdown:hover .dropdown-menu{display:block}
    .dropdown-menu a, .dropdown-menu span{display:block; padding:10px 16px; text-decoration:none; color:#333; white-space:nowrap}
    .dropdown-menu a:hover{background:#f4f4f4}
    .cart-icon-container { position: relative; display: inline-block; }
    .cart-count-badge { position: absolute; top: -8px; right: -8px; background-color: var(--accent); color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; }

    /* Layout + cards */
    .wrap{max-width:1200px; margin:22px auto; padding:0 6%}
    h1{margin:0 0 18px; color:var(--green); font-size:28px}
    .grid{display:grid; grid-template-columns:1fr 420px; gap:28px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card); border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); padding:18px}
    .card h2{font-size:18px; margin:0 0 12px; color:#333}

    /* Form */
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .form-grid .full{grid-column:1 / -1}
    label{display:block; font-size:13px; color:#444; margin:4px 0 6px}
    input, select{width:100%; padding:11px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; transition:border-color .2s}
    input:focus, select:focus { outline:none; border-color:var(--green) }
    .muted{color:#777; font-size:13px}

    /* Summary */
    .summary h3{margin:0 0 12px; color:#333}
    .row{display:flex; justify-content:space-between; margin:8px 0}
    .row.total{font-size:18px; font-weight:800; padding-top:12px; border-top:1px dashed #ddd}

    .btn-primary{
      display:inline-flex; align-items:center; gap:10px; background:var(--green); color:#fff; border:none;
      padding:14px 18px; border-radius:10px; font-weight:800; cursor:pointer; width:100%; justify-content:center;
      font-size:16px; transition:background-color .2s, transform .1s;
    }
    .btn-primary:hover{background:var(--accent); transform:translateY(-1px)}
    .links{margin-top:10px; text-align:center}
    .links a{color:#218838; text-decoration:none}

    /* Address picker */
    .addr-list{display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:10px}
    .addr-card{
      display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start;
      border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#fff;
    }
    .addr-radio{accent-color:var(--green); margin-top:3px}
    .addr-meta{font-size:13px; color:#444; line-height:1.45}
    .addr-name{font-weight:700; color:#111; margin-bottom:4px}
    .addr-actions{display:flex; gap:8px; margin-top:4px}
    .btn-sm{border:1px solid #d9e2d9; background:#f8fff8; color:#1f7a1f; padding:6px 10px; border-radius:8px; font-weight:700; cursor:pointer; font-size:12px}
    .btn-sm.secondary{background:#fff; color:#333}
    .picker-head{display:flex; justify-content:space-between; align-items:center; margin:0 0 8px}
    .picker-head a{font-size:13px; text-decoration:none; color:var(--green); font-weight:700}
    .sep{height:1px; background:#eee; margin:12px 0}

    /* Footer (unchanged) */
    .site-footer{background:#222; color:#ccc; padding:40px 6%; margin-top:40px;}
    .footer-container{display:flex; flex-wrap:wrap; justify-content:space-between; gap:30px; margin-bottom:30px}
    .footer-column{flex:1; min-width:220px}
    .footer-column h3{color:#fff; margin-bottom:15px; font-weight:600; border-bottom:2px solid var(--green); padding-bottom:8px; display:inline-block}
    .footer-column p{line-height:1.6; font-size:14px}
    .footer-column ul{list-style:none; padding:0; margin:0}
    .footer-column ul li a{text-decoration:none; color:#ccc; display:block; padding:5px 0; font-size:14px; transition:color .3s}
    .footer-column ul li a:hover{color:#fff}
    .social-links a{color:#ccc; text-decoration:none; font-size:20px; margin-right:15px; transition:color .3s}
    .social-links a:hover{color:var(--green)}
    .footer-bottom{text-align:center; padding-top:20px; border-top:1px solid #444; font-size:14px}
    @media (max-width: 768px){ .footer-container{flex-direction:column; text-align:center} .footer-column h3{border-bottom:none; padding-bottom:0; margin-bottom:10px} .footer-column{margin-bottom:20px} }
  </style>
</head>
<body>

<!-- Navbar -->
<!-- Navbar -->
<nav class="navbar">
  <a href="/" class="brand-logo">
    <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
    <span>SpiceJar</span>
  </a>

  <div class="nav-links">
    <a th:href="@{/menu}">Menu</a>
    <a th:href="@{/about}">About Us</a>
    <a class="nav-link" th:href="@{/cart/view}">
      <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
        <i class="fas fa-shopping-cart" style="font-size:24px"></i>
        <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
      </div>
    </a>
    <a th:href="@{/contact}">Contact Us</a>

    <!-- Categories -->
    <div class="dropdown">
      <button class="dropdown-toggle">
        <i class="fa-solid fa-list"></i> Categories
      </button>
      <div class="dropdown-menu">
        <a th:each="c : ${categories}"
           th:href="@{/category/{id}(id=${c.id})}"
           th:text="${c.name}">Category</a>
      </div>
    </div>

    <!-- Account -->
    <div class="dropdown">
      <button class="dropdown-toggle">
        <i class="fas fa-user"></i>
        <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
      </button>
      <div class="dropdown-menu">
        <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
        <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>

        <span th:if="${session.USER != null}">
          Welcome, <strong th:text="${session.USER.firstName}">User</strong>
        </span>
        <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
        <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
        <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
      </div>
    </div>
  </div>
</nav>


<main class="wrap">
  <h1>Secure checkout</h1>

  <!-- SUBMITS to /order/place -->
  <form th:action="@{/order/place}" method="post" id="checkout-form">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <!-- gets set when a saved address is chosen -->
    <input type="hidden" name="addressId" id="addressId"/>

    <div class="grid">
      <!-- Left: Shipping & Contact -->
      <section class="card">
        <div class="picker-head">
          <h2 style="margin:0">Shipping & Contact</h2>
          <a th:href="@{/addresses}"><i class="fa-regular fa-address-book"></i> Manage addresses</a>
        </div>

        <!-- Address picker (only if user has saved addresses) -->


        <div th:if="${addresses != null and !#lists.isEmpty(addresses)}">
          <div class="addr-list">
            <!-- th:each only here -->
            <div class="addr-card" th:each="a,iter : ${addresses}">
              <input class="addr-radio" type="radio" name="addrPick" th:value="${a.id}"/>

              <div class="addr-meta">
                <div class="addr-name" th:text="${a.fullName}">Full Name</div>
                <div th:text="${a.phone}">555-123-4567</div>
                <div th:text="${a.line1}">123 Main St, Apt 4B</div>
                <div th:if="${a.line2 != null}" th:text="${a.line2}"></div>
                <div>
                  <span th:text="${a.city}">City</span>,
                  <span th:text="${a.state}">State</span>
                  <span th:text="${a.zip}">00000</span>
                </div>
                <div th:text="${a.country}">United States</div>

                <!-- put all data-* here so 'a' is definitely in scope -->
                <div class="addr-dataset"
                     th:attr="data-fullname=${a.fullName},
                      data-phone=${a.phone},
                      data-line1=${a.line1},
                      data-line2=${a.line2},
                      data-city=${a.city},
                      data-state=${a.state},
                      data-zip=${a.zip},
                      data-country=${a.country}"></div>
              </div>
            </div>
          </div>

          <div class="addr-actions">
            <button type="button" class="btn-sm" id="useSelected">
              <i class="fa-solid fa-check"></i> Use this address
            </button>
            <button type="button" class="btn-sm secondary" id="clearSelected">
              <i class="fa-solid fa-eraser"></i> Clear selection
            </button>
          </div>
          <div class="sep"></div>
        </div>


        <!-- Manual form (can be pre-filled by the picker) -->
        <div class="form-grid">
          <div class="full">
            <label>Full name</label>
            <input id="f_fullname" name="customerName" placeholder="e.g., Priya Sharma" required>
          </div>

          <div>
            <label>Email</label>
            <input id="f_email" name="email" type="email" required>
          </div>
          <div>
            <label>Phone</label>
            <input id="f_phone" name="phone" type="tel" required>
          </div>

          <div class="full">
            <label>Street address line 1</label>
            <input id="f_line1" name="line1" placeholder="123 Main St, Apt 4B" required>
          </div>

          <div class="full">
            <label>Street address line 2</label>
            <input id="f_line2" name="line2" placeholder="e.g., Suite 200">
          </div>

          <div>
            <label>City</label>
            <input id="f_city" name="city" required>
          </div>
          <div>
            <label>State</label>
            <input id="f_state" name="state" required>
          </div>
          <div>
            <label>ZIP</label>
            <input id="f_zip" name="zip" required>
          </div>
          <div>
            <label>Country</label>
            <select id="f_country" name="country" required>
              <option value="" disabled selected>Select</option>
              <option>United States</option>
              <option>Canada</option>
              <option>United Kingdom</option>
              <option>India</option>
              <option>Australia</option>
            </select>
          </div>
        </div>

        <p class="muted" style="margin-top:10px">
          <i class="fa-solid fa-lock"></i> All payments are processed on the next page via a secure connection.
        </p>
      </section>

      <!-- Right: Order summary -->
      <aside class="card summary">
        <h2>Order summary</h2>
        <div class="row"><span>Items</span><span th:text="${cart.items.size()}">0</span></div>
        <div class="row"><span>Subtotal</span><span th:text="${#numbers.formatDecimal(cart.subtotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
        <div class="row"><span>Tax (8%)</span><span th:text="${#numbers.formatDecimal(cart.tax,1,'COMMA',2,'POINT')}">$0.00</span></div>
        <div class="row total"><span>Total</span><span th:text="${#numbers.formatDecimal(cart.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span></div>

        <button type="submit" class="btn-primary" style="margin-top:20px" id="checkout-btn">
          <i class="fa-solid fa-arrow-right"></i> Continue to payment
        </button>

        <div class="links"><a th:href="@{/cart/view}">Back to cart</a></div>
      </aside>
    </div>
  </form>
</main>

<footer class="site-footer">
  <div class="footer-container">
    <div class="footer-column">
      <h3>About Spice Jar</h3>
      <p>Bringing the world's finest spices to your kitchen. Quality, aroma, and flavor guaranteed in every jar.</p>
    </div>
    <div class="footer-column">
      <h3>Quick Links</h3>
      <ul>
        <li><a th:href="@{/menu}">Menu</a></li>
        <li><a th:href="@{/about}">About Us</a></li>
        <li><a th:href="@{/contact}">Contact</a></li>
        <li><a href="#">FAQ</a></li>
      </ul>
    </div>
    <div class="footer-column">
      <h3>Connect With Us</h3>
      <div class="social-links">
        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
      </div>
    </div>
  </div>
  <div class="footer-bottom"><p>&copy; 2025 The Spice Jar. All rights reserved.</p></div>
</footer>

<script>
  // Button loading state
  const form = document.getElementById('checkout-form');
  const button = document.getElementById('checkout-btn');
  form.addEventListener('submit', () => {
    button.disabled = true;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin-pulse"></i> Processing...';
  });

  // Address picker -> fill fields + set hidden addressId
  const radios = document.querySelectorAll('.addr-radio');
  const useBtn = document.getElementById('useSelected');
  const clearBtn = document.getElementById('clearSelected');
  const addressIdEl = document.getElementById('addressId');

  function selectedRadio() {
    for (const r of radios) if (r.checked) return r;
    return null;
  }

  useBtn?.addEventListener('click', () => {
    const r = selectedRadio();
    if (!r) return;

    // The data-* now live on a sibling inside the same card
    const ds = r.closest('.addr-card')?.querySelector('.addr-dataset')?.dataset || {};

    // Set hidden id so backend can use saved address
    addressIdEl.value = r.value;

    // Copy values into the form (user can still edit)
    document.getElementById('f_fullname').value = ds.fullname || '';
    document.getElementById('f_phone').value    = ds.phone    || '';
    document.getElementById('f_line1').value    = ds.line1    || '';
    document.getElementById('f_line2').value    = ds.line2    || '';
    document.getElementById('f_city').value     = ds.city     || '';
    document.getElementById('f_state').value    = ds.state    || '';
    document.getElementById('f_zip').value      = ds.zip      || '';
    document.getElementById('f_country').value  = ds.country  || '';
  });


  clearBtn?.addEventListener('click', () => {
    addressIdEl.value = '';
    radios.forEach(r => r.checked = false);
  });
</script>
</body>
</html>
