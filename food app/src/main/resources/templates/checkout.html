<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Checkout • The Spice Jar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23218838'/%3E%3Cpath fill='%23fff' d='M10 21c0-4.2 5-4.2 5-8 0-1.4-.8-2.6-2-3.5 3 .3 5 2.2 5 4.7 0 3.6-4 4.6-4 7.8h6v1.5H10V21z'/%3E%3C/svg%3E">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --green:#218838;
            --accent:#b7410e;
            --dark:#111827;
            --bg:#f5faf6;
            --card:#ffffff;
            --ring:rgba(15,23,42,.08);
        }

        * { box-sizing:border-box; }

        body {
            font-family:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
            margin:0;
            background:radial-gradient(circle at top left, #f1fdf3 0, #f5faf6 40%, #f9fafb 100%);
            color:#111827;
        }

        a { color:inherit; }

        /* Navbar */
        .navbar{
            background:rgba(255,255,255,0.96);
            backdrop-filter:blur(8px);
            padding:8px 6%;
            box-shadow:0 2px 8px rgba(15,23,42,.06);
            display:flex;
            justify-content:space-between;
            align-items:center;
            position:sticky;
            top:0;
            z-index:1000;
            height:64px;
            gap:14px;
        }

        .brand-logo{
            display:flex;
            align-items:center;
            gap:8px;
            text-decoration:none;
            color:var(--green);
            font-weight:800;
            font-size:20px;
            letter-spacing:.02em;
        }

        .brand-logo video{
            width:36px;
            height:36px;
            border-radius:8px;
            object-fit:cover;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-search{
            flex:1;
            max-width:520px;
            display:flex;
            align-items:center;
            gap:8px;
        }

        .nav-search input{
            width:100%;
            padding:9px 12px;
            border:1px solid #d1d5db;
            border-radius:999px;
            background:#fff;
            font-size:14px;
            outline:none;
        }

        .nav-search input:focus{
            border-color:var(--green);
            box-shadow:0 0 0 2px rgba(34,197,94,0.2);
        }

        .nav-search button{
            border:none;
            border-radius:999px;
            padding:8px 11px;
            background:var(--green);
            color:#fff;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }

        .nav-search button:hover{background:var(--accent);}

        .nav-links{
            display:flex;
            align-items:center;
            gap:18px;
            flex-wrap:wrap;
        }

        .nav-links a{
            text-decoration:none;
            color:#374151;
            font-weight:500;
            font-size:14px;
            position:relative;
            padding:4px 0;
        }

        .nav-links a::after{
            content:"";
            position:absolute;
            left:0;
            bottom:-3px;
            width:0;
            height:2px;
            background:var(--green);
            border-radius:999px;
            transition:width .18s ease;
        }

        .nav-links a:hover::after{
            width:100%;
        }

        .cart-icon-container { position:relative; display:inline-flex; align-items:center; justify-content:center; }
        .cart-count-badge {
            position:absolute;
            top:-6px;
            right:-10px;
            background-color:var(--accent);
            color:#fff;
            border-radius:999px;
            padding:1px 7px;
            font-size:11px;
            font-weight:700;
            min-width:18px;
            height:18px;
            display:flex;
            align-items:center;
            justify-content:center;
            line-height:1;
            box-shadow:0 0 0 2px #fff;
        }

        /* Dropdown */
        .dropdown{position:relative}
        .dropdown-toggle{
            background:none;
            border:none;
            cursor:pointer;
            font-size:14px;
            color:#111827;
            display:flex;
            align-items:center;
            gap:6px;
            padding:6px 10px;
            border-radius:999px;
            font-weight:700;
            transition:background .15s ease, box-shadow .15s ease;
        }
        .dropdown-toggle:hover{
            background:#f3f4f6;
            box-shadow:0 0 0 1px rgba(148,163,184,0.3);
        }
        .dropdown-menu{
            display:none;
            position:absolute;
            right:0;
            top:calc(100% + 8px);
            background:#fff;
            box-shadow:0 10px 28px rgba(15,23,42,0.18);
            border-radius:12px;
            overflow:hidden;
            min-width:200px;
            border:1px solid #e5e7eb;
        }
        .dropdown:hover .dropdown-menu{display:block}
        .dropdown-menu a, .dropdown-menu span{
            display:block;
            padding:10px 14px;
            text-decoration:none;
            color:#111827;
            white-space:nowrap;
            font-size:14px;
            font-weight:500;
        }
        .dropdown-menu a:hover{background:#f7faf7}

        /* Layout + cards */
        .wrap{
            max-width:1200px;
            margin:22px auto 36px;
            padding:0 4%;
        }

        h1{
            margin:4px 0 4px;
            color:var(--dark);
            font-size:26px;
            letter-spacing:.01em;
        }

        .checkout-subtitle{
            margin:0 0 18px;
            color:#6b7280;
            font-size:13px;
        }

        .grid{
            display:grid;
            grid-template-columns: minmax(0,1.2fr) minmax(320px, 0.8fr);
            gap:24px;
        }

        @media (max-width:980px){
            .grid{ grid-template-columns:1fr; }
        }

        .card{
            background:var(--card);
            border-radius:16px;
            box-shadow:0 10px 30px var(--ring);
            padding:18px 18px 20px;
            border:1px solid rgba(209,213,219,0.85);
        }

        .card h2{
            font-size:18px;
            margin:0 0 8px;
            color:#111827;
        }

        /* Step pill */
        .step-pill{
            display:inline-flex;
            align-items:center;
            gap:6px;
            font-size:11px;
            font-weight:700;
            text-transform:uppercase;
            letter-spacing:.12em;
            padding:4px 10px;
            border-radius:999px;
            background:#ecfdf3;
            color:#166534;
            margin-bottom:4px;
        }

        /* Form */
        .form-grid{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:14px;
        }
        .form-grid .full{grid-column:1 / -1}
        label{
            display:block;
            font-size:12px;
            color:#4b5563;
            margin:3px 0 5px;
            font-weight:600;
        }
        input, select{
            width:100%;
            padding:10px 11px;
            border:1px solid #d1d5db;
            border-radius:10px;
            font-size:14px;
            transition:border-color .2s, box-shadow .2s;
            background:#fff;
        }
        input:focus, select:focus{
            outline:none;
            border-color:var(--green);
            box-shadow:0 0 0 2px rgba(34,197,94,0.20);
        }
        .muted{
            color:#6b7280;
            font-size:12px;
        }

        /* Address picker */
        .picker-head{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin:0 0 8px;
        }
        .picker-head a{
            font-size:12px;
            text-decoration:none;
            color:var(--green);
            font-weight:700;
        }
        .picker-head a:hover{text-decoration:underline}

        .addr-list{
            display:grid;
            grid-template-columns:1fr;
            gap:10px;
            margin-bottom:10px;
        }
        .addr-card{
            display:grid;
            grid-template-columns:auto 1fr;
            gap:10px;
            align-items:flex-start;
            border:1px solid #e5e7eb;
            border-radius:12px;
            padding:10px 12px;
            background:#fff;
        }
        .addr-radio{accent-color:var(--green); margin-top:3px}
        .addr-meta{
            font-size:13px;
            color:#4b5563;
            line-height:1.45;
        }
        .addr-name{
            font-weight:700;
            color:#111827;
            margin-bottom:4px;
        }
        .addr-actions{
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:6px;
        }
        .btn-sm{
            border:1px solid #d9e2d9;
            background:#f8fff8;
            color:#166534;
            padding:6px 10px;
            border-radius:999px;
            font-weight:700;
            cursor:pointer;
            font-size:12px;
        }
        .btn-sm.secondary{
            background:#fff;
            color:#374151;
        }
        .btn-sm i{margin-right:4px}
        .sep{height:1px; background:#e5e7eb; margin:12px 0}

        /* Summary */
        .summary{ position:sticky; top:88px; }

        .summary h2{
            margin-bottom:10px;
        }

        .row{
            display:flex;
            justify-content:space-between;
            margin:6px 0;
            font-size:14px;
        }
        .row.total{
            font-size:16px;
            font-weight:800;
            padding-top:10px;
            border-top:1px dashed #d1d5db;
        }

        .btn-primary{
            display:inline-flex;
            align-items:center;
            gap:8px;
            background:linear-gradient(90deg,#22c55e,#16a34a);
            color:#fff;
            border:none;
            padding:12px 16px;
            border-radius:999px;
            font-weight:800;
            cursor:pointer;
            justify-content:center;
            font-size:15px;
            transition:transform .1s, box-shadow .15s;
            width:100%;
            box-shadow:0 10px 24px rgba(22,163,74,0.4);
        }
        .btn-primary:hover{
            box-shadow:0 14px 30px rgba(22,163,74,0.5);
            transform:translateY(-1px);
        }
        .btn-primary i{font-size:14px}

        .links{
            margin-top:10px;
            text-align:center;
            font-size:13px;
        }
        .links a{
            color:var(--green);
            text-decoration:none;
        }
        .links a:hover{text-decoration:underline}

        /* Coupon */
        .coupon-box{
            border:1px dashed #e0e6df;
            border-radius:12px;
            padding:10px 10px 8px;
            margin-bottom:12px;
            background:#f9fafb;
        }
        .coupon-row{
            display:flex;
            gap:8px;
            align-items:stretch;
        }
        .coupon-row input{
            flex:1;
            padding:10px 11px;
            border-radius:10px;
            border:1px solid #d1d5db;
        }

        .btn-ghost{
            background:#eef6f0;
            color:#166534;
            border:1px solid #d7eadf;
            border-radius:10px;
            padding:10px 12px;
            font-weight:700;
            cursor:pointer;
            font-size:13px;
            white-space:nowrap;
        }

        .note{font-size:12px;color:#6b7280;margin-top:6px}

        #checkout-btn { width:100%; }
        #coupon-apply, #coupon-remove { width:auto; }

        /* Footer */
        .site-footer{
            background:#111827;
            color:#9ca3af;
            padding:40px 6% 26px;
            margin-top:40px;
        }
        .footer-container{
            display:flex;
            flex-wrap:wrap;
            justify-content:space-between;
            gap:30px;
            margin-bottom:30px;
        }
        .footer-column{flex:1; min-width:220px}
        .footer-column h3{
            color:#f9fafb;
            margin-bottom:14px;
            font-weight:600;
            border-bottom:2px solid var(--green);
            padding-bottom:6px;
            display:inline-block;
            font-size:15px;
        }
        .footer-column p{line-height:1.6; font-size:14px}
        .footer-column ul{list-style:none; padding:0; margin:0}
        .footer-column ul li a{
            text-decoration:none;
            color:#9ca3af;
            display:block;
            padding:5px 0;
            font-size:14px;
            transition:color .2s ease, transform .1s ease;
        }
        .footer-column ul li a:hover{
            color:#e5e7eb;
            transform:translateX(2px);
        }
        .social-links a{
            color:#9ca3af;
            text-decoration:none;
            font-size:20px;
            margin-right:16px;
            transition:color .2s ease, transform .1s ease;
        }
        .social-links a:hover{
            color:var(--green);
            transform:translateY(-1px);
        }
        .footer-bottom{
            text-align:center;
            padding-top:18px;
            border-top:1px solid #1f2937;
            font-size:13px;
            color:#6b7280;
        }

        @media (max-width:768px){
            .navbar{
                flex-wrap:wrap;
                height:auto;
            }
            .nav-search{
                order:3;
                width:100%;
                max-width:none;
            }
            .footer-container{
                flex-direction:column;
                text-align:left;
            }
            .footer-column{margin-bottom:12px}
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="/images/Spice-Jar.mp4" autoplay muted loop playsinline></video>
        <span>SpiceJar</span>
    </a>

    <form class="nav-search" role="search" onsubmit="return false;">
        <input id="nav-q" type="search" placeholder="Search spices…" aria-label="Search" th:value="${q}">
        <button id="nav-search-btn" type="button" aria-label="Search">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>
    </form>

    <div class="nav-links">
        <a th:href="@{/menu}">Menu</a>
        <a th:href="@{/about}">About Us</a>
        <a class="nav-link" th:href="@{/cart/view}">
            <div class="cart-icon-container" aria-live="polite" aria-label="Cart items">
                <i class="fas fa-shopping-cart" style="font-size:20px"></i>
                <span class="cart-count-badge" id="lblCartCount" th:text="${cartCount}">0</span>
            </div>
        </a>
        <a th:href="@{/contact}">Contact Us</a>

        <div class="dropdown">
            <button class="dropdown-toggle" type="button">
                <i class="fas fa-user"></i>
                <span th:text="${session.USER != null ? session.USER.firstName : 'Account'}">Account</span>
            </button>
            <div class="dropdown-menu">
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>

                <span th:if="${session.USER != null}">
                    Welcome, <strong th:text="${session.USER.firstName}">User</strong>
                </span>
                <a th:if="${session.USER != null}" th:href="@{/account}">Your Account</a>
                <a th:if="${session.USER != null}" th:href="@{/orders}">My Orders</a>
                <a th:if="${session.USER != null}" th:href="@{/logout}">Logout</a>
            </div>
        </div>
    </div>
</nav>

<main class="wrap">
    <div>
        <span class="step-pill">
            <i class="fa-solid fa-lock"></i> Step 1 of 2 • Shipping
        </span>
        <h1>Secure checkout</h1>
        <p class="checkout-subtitle">Enter your shipping details and apply coupons before continuing to payment.</p>
    </div>

    <!-- SUBMITS to /order/place -->
    <form th:action="@{/order/place}" method="post" id="checkout-form">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="addressId" id="addressId"/>

        <!-- ✅ REMOVED wallet hidden field -->
        <!-- <input type="hidden" name="pointsUsed" id="pointsUsed" value="0"/> -->

        <div class="grid">
            <!-- Left: Shipping & Contact -->
            <section class="card">
                <div class="picker-head">
                    <div>
                        <h2 style="margin:0">Shipping &amp; contact</h2>
                    </div>
                    <a th:href="@{/addresses}">
                        <i class="fa-regular fa-address-book"></i> Manage addresses
                    </a>
                </div>

                <div th:if="${addresses != null and !#lists.isEmpty(addresses)}">
                    <div class="addr-list">
                        <div class="addr-card" th:each="a,iter : ${addresses}">
                            <input class="addr-radio" type="radio" name="addrPick" th:value="${a.id}"/>
                            <div class="addr-meta">
                                <div class="addr-name" th:text="${a.fullName}">Full Name</div>
                                <div th:text="${a.phone}">555-123-4567</div>
                                <div th:text="${a.line1}">123 Main St, Apt 4B</div>
                                <div th:if="${a.line2 != null}" th:text="${a.line2}"></div>
                                <div>
                                    <span th:text="${a.city}">City</span>,
                                    <span th:text="${a.state}">State</span>
                                    <span th:text="${a.zip}">00000</span>
                                </div>
                                <div th:text="${a.country}">United States</div>

                                <div class="addr-dataset"
                                     th:attr="data-fullname=${a.fullName},
                      data-phone=${a.phone},
                      data-line1=${a.line1},
                      data-line2=${a.line2},
                      data-city=${a.city},
                      data-state=${a.state},
                      data-zip=${a.zip},
                      data-country=${a.country}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="addr-actions">
                        <button type="button" class="btn-sm" id="useSelected">
                            <i class="fa-solid fa-check"></i> Use this address
                        </button>
                        <button type="button" class="btn-sm secondary" id="clearSelected">
                            <i class="fa-solid fa-eraser"></i> Clear selection
                        </button>
                    </div>
                    <div class="sep"></div>
                </div>

                <div class="form-grid">
                    <div class="full">
                        <label for="f_fullname">Full name</label>
                        <input id="f_fullname" name="customerName" placeholder="e.g., Priya Sharma" required>
                    </div>
                    <div>
                        <label for="f_email">Email</label>
                        <input id="f_email" name="email" type="email" required>
                    </div>
                    <div>
                        <label for="f_phone">Phone</label>
                        <input id="f_phone" name="phone" type="tel" required>
                    </div>
                    <div class="full">
                        <label for="f_line1">Street address line 1</label>
                        <input id="f_line1" name="street" placeholder="123 Main St, Apt 4B" required>
                    </div>
                    <div class="full">
                        <label for="f_line2">Street address line 2</label>
                        <input id="f_line2" name="line2" placeholder="e.g., Suite 200">
                    </div>
                    <div>
                        <label for="f_city">City</label>
                        <input id="f_city" name="city" required>
                    </div>
                    <div>
                        <label for="f_state">State</label>
                        <input id="f_state" name="state" required>
                    </div>
                    <div>
                        <label for="f_zip">ZIP</label>
                        <input id="f_zip" name="zip" required>
                    </div>
                    <div>
                        <label for="f_country">Country</label>
                        <select id="f_country" name="country" required>
                            <option value="" disabled selected>Select</option>
                            <option>United States</option>
                            <option>Canada</option>
                            <option>United Kingdom</option>
                            <option>India</option>
                            <option>Australia</option>
                        </select>
                    </div>
                </div>

                <p class="muted" style="margin-top:12px">
                    <i class="fa-solid fa-lock"></i>
                    Your details are encrypted and your payment is processed securely on the next step.
                </p>
            </section>

            <!-- Right: Order summary -->
            <aside class="card summary">
                <h2>Order summary</h2>

                <!-- Gift card-only message -->
                <div th:if="${cartHasGiftCard}"
                     class="coupon-box"
                     style="background:#fff8e1;border-color:#facc15;margin-bottom:16px">
                    <strong><i class="fa-solid fa-gift"></i> Gift card order</strong><br/>
                    Gift card purchases are <strong>not eligible</strong> for discount codes or coupons.
                </div>

                <!-- When cart does NOT contain gift cards: normal coupon UI -->
                <div th:if="${!cartHasGiftCard}">
                    <!-- Coupon code input -->
                    <div class="coupon-box">
                        <div class="coupon-row">
                            <input id="coupon-input" type="text" placeholder="Discount code"
                                   th:value="${cart.appliedCouponCode}">
                            <button id="coupon-apply" type="button" class="btn-ghost"
                                    style="background:#218838;color:#fff;border-color:#166534;">
                                <i class="fa-solid fa-badge-percent"></i>&nbsp;Apply
                            </button>
                            <button id="coupon-remove" type="button" class="btn-ghost"
                                    th:style="${cart.appliedCouponCode}!=null? 'display:inline-block' : 'display:none'">
                                Remove
                            </button>
                        </div>
                        <div id="coupon-msg" class="muted"
                             th:text="${cart.appliedCouponCode!=null ? 'Code ' + cart.appliedCouponCode + ' applied' : ''}">
                        </div>
                    </div>

                    <!-- Available coupons list (from admin) -->
                    <div th:if="${availableCoupons != null and !#lists.isEmpty(availableCoupons)}"
                         class="coupon-box" style="margin-top:10px">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <h3 style="margin:0;font-size:15px;color:#111827">Available coupons</h3>
                            <span class="muted" th:text="${availableCoupons.size()} + ' available'">0 available</span>
                        </div>

                        <div style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;padding-right:4px">
                            <div th:each="c : ${availableCoupons}"
                                 style="display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px dashed #e0e6df;border-radius:10px;padding:10px">
                                <div style="display:flex;flex-direction:column;gap:4px;min-width:0">
                                    <div>
                                        <span style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef6f0;border:1px solid #d7eadf;color:#166534;font-weight:800;letter-spacing:.3px"
                                              th:text="${c.code}">SAVE10</span>
                                        <span class="muted" style="margin-left:6px"
                                              th:text="${c.type.name()=='PERCENT' ? (c.value + '% off') : ('$' + #numbers.formatDecimal(c.value,1,'COMMA',2,'POINT') + ' off')}">
                                            10% off
                                        </span>
                                    </div>
                                    <div class="muted" style="font-size:12px;line-height:1.3">
                                        <span th:if="${c.minSubtotal != null and c.minSubtotal > 0}"
                                              th:text="${'Min subtotal $' + #numbers.formatDecimal(c.minSubtotal,1,'COMMA',2,'POINT')}">
                                            Min subtotal $0.00
                                        </span>
                                        <span th:if="${c.minSubtotal == null or c.minSubtotal == 0}">No minimum</span>
                                        <span> • </span>
                                        <span th:text="${c.expiresOn != null ? 'Expires ' + c.expiresOn : 'No expiry'}">
                                            No expiry
                                        </span>
                                    </div>
                                </div>

                                <button type="button"
                                        class="btn-ghost coupon-quick-apply"
                                        th:attr="data-code=${c.code}">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <span>Items</span>
                    <span th:text="${cart.items.size()}">0</span>
                </div>
                <div class="row">
                    <span>Subtotal</span>
                    <span>$ <span data-total="subtotal" th:text="${#numbers.formatDecimal(cart.subtotal,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>
                <div class="row">
                    <span>Discount</span>
                    <span>− $ <span data-total="discount" th:text="${#numbers.formatDecimal(cart.discount,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>
                <div class="row">
                    <span>Tax (8%)</span>
                    <span>$ <span data-total="tax" th:text="${#numbers.formatDecimal(cart.tax,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>
                <div class="row total">
                    <span>Total</span>
                    <span>$ <span data-total="grand" th:text="${#numbers.formatDecimal(cart.grandTotal,1,'COMMA',2,'POINT')}">0.00</span></span>
                </div>

                <button type="submit" class="btn-primary" style="margin-top:20px" id="checkout-btn">
                    <i class="fa-solid fa-arrow-right"></i>
                    Continue to payment
                </button>
                <div class="links">
                    <a th:href="@{/cart/view}">Back to cart</a>
                </div>
            </aside>
        </div>
    </form>
</main>

<footer class="site-footer">
    <div class="footer-container">
        <div class="footer-column">
            <h3>About Spice Jar</h3>
            <p>Bringing the world's finest spices to your kitchen. Quality, aroma, and flavor guaranteed in every jar.</p>
        </div>
        <div class="footer-column">
            <h3>Quick Links</h3>
            <ul>
                <li><a th:href="@{/menu}">Menu</a></li>
                <li><a th:href="@{/about}">About Us</a></li>
                <li><a th:href="@{/contact}">Contact</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Connect With Us</h3>
            <div class="social-links">
                <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
            </div>
        </div>
    </div>
    <div class="footer-bottom"><p>&copy; 2025 The Spice Jar. All rights reserved.</p></div>
</footer>

<script>
    // Button loading state
    const form = document.getElementById('checkout-form');
    const button = document.getElementById('checkout-btn');
    form.addEventListener('submit', () => {
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin-pulse"></i> Processing...';
    });

    // Address picker
    const radios = document.querySelectorAll('.addr-radio');
    const useBtn = document.getElementById('useSelected');
    const clearBtn = document.getElementById('clearSelected');
    const addressIdEl = document.getElementById('addressId');

    function selectedRadio() {
        for (const r of radios) if (r.checked) return r;
        return null;
    }

    useBtn?.addEventListener('click', () => {
        const r = selectedRadio();
        if (!r) return;
        const ds = r.closest('.addr-card')?.querySelector('.addr-dataset')?.dataset || {};
        addressIdEl.value = r.value;
        document.getElementById('f_fullname').value = ds.fullname || '';
        document.getElementById('f_phone').value = ds.phone || '';
        document.getElementById('f_line1').value = ds.line1 || '';
        document.getElementById('f_line2').value = ds.line2 || '';
        document.getElementById('f_city').value = ds.city || '';
        document.getElementById('f_state').value = ds.state || '';
        document.getElementById('f_zip').value = ds.zip || '';
        document.getElementById('f_country').value = ds.country || '';
    });

    clearBtn?.addEventListener('click', () => {
        addressIdEl.value = '';
        radios.forEach(r => r.checked = false);
    });

    // Coupon JS
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

    const cInput = document.getElementById('coupon-input');
    const cMsg   = document.getElementById('coupon-msg');
    const btnA   = document.getElementById('coupon-apply');
    const btnR   = document.getElementById('coupon-remove');

    function fmt(n){ return Number(n ?? 0).toFixed(2); }
    function setTotals(o){
        const map = {
            subtotal: document.querySelector('[data-total="subtotal"]'),
            discount: document.querySelector('[data-total="discount"]'),
            tax:      document.querySelector('[data-total="tax"]'),
            grand:    document.querySelector('[data-total="grand"]'),
        };
        if(map.subtotal) map.subtotal.textContent = fmt(o.subtotal);
        if(map.discount) map.discount.textContent = fmt(o.discount);
        if(map.tax)      map.tax.textContent      = fmt(o.tax);
        if(map.grand)    map.grand.textContent    = fmt(o.grandTotal);
        const badge = document.getElementById('lblCartCount');
        if (badge && o.cartCount != null) badge.textContent = o.cartCount;
    }
    function msg(t){ if (cMsg) cMsg.textContent = t || ''; }

    async function postFlexible(url, data){
        const baseHeaders = { 'X-Requested-With': 'XMLHttpRequest' };
        if (CSRF_TOKEN && CSRF_HEADER) baseHeaders[CSRF_HEADER] = CSRF_TOKEN;

        // try form first
        let res = await fetch(url, {
            method: 'POST',
            headers: { ...baseHeaders, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data || {})
        });

        // retry as JSON if 415
        if (res.status === 415) {
            res = await fetch(url, {
                method: 'POST',
                headers: { ...baseHeaders, 'Content-Type': 'application/json' },
                body: JSON.stringify(data || {})
            });
        }

        try {
            const json = await res.json();
            return { ok: res.ok, status: res.status, body: json };
        } catch {
            return { ok: false, status: res.status, body: { status:'error', message:'Bad response from server' } };
        }
    }

    btnA?.addEventListener('click', async ()=>{
        const code = (cInput?.value || '').trim();
        if (!code){ msg('Please enter a code.'); return; }
        const prev = btnA.innerHTML;
        btnA.disabled = true;
        btnA.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        const r = await postFlexible('/api/cart/coupon/apply', { code });
        btnA.disabled = false;
        btnA.innerHTML = prev;
        const out = r.body || {};
        msg(out.message || (r.ok ? 'Done' : 'Server error'));
        if (out.status === 'success' && btnR) btnR.style.display = 'inline-block';
        if (out.subtotal != null) setTotals(out);
    });

    btnR?.addEventListener('click', async ()=>{
        const prev = btnR.innerHTML;
        btnR.disabled = true;
        btnR.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        const r = await postFlexible('/api/cart/coupon/remove', {});
        btnR.disabled = false;
        btnR.innerHTML = prev;
        const out = r.body || {};
        msg(out.message || (r.ok ? 'Removed' : 'Server error'));
        if (btnR) btnR.style.display = 'none';
        if (cInput) cInput.value = '';
        if (out.subtotal != null) setTotals(out);
    });

    // 1-click apply from the coupon list
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.coupon-quick-apply');
        if (!btn) return;
        const code = btn.dataset.code || '';
        if (!code) return;
        const input = document.getElementById('coupon-input');
        if (input) input.value = code;
        const applyBtn = document.getElementById('coupon-apply');
        if (applyBtn) applyBtn.click();
    });

    // ✅ REMOVED wallet JS entirely (no walletPointsInput / wallet-apply / wallet-remove handlers)
</script>
</body>
</html>
