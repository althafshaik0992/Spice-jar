<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Pay â€¢ The Spice Jar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root{--green:#388E3C;--accent:#FF5722;--ink:#212121;--bg:#f0f4f0;--card:#fff;--shadow:0 10px 30px rgba(0,0,0,.06)}
        *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--ink); display: flex; flex-direction: column; align-items: center; min-height: 100vh;}
        .navbar{background:#fff;padding:12px 6%;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;width:100%; box-sizing: border-box;}
        .brand-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--green);
            font-weight: 700;
            font-size: 24px;
            gap: 8px;
        }
        .brand-logo video {
            width: 50px;
            height: auto;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .nav-links a {
            text-decoration: none;
            color: #333;
        }
        .order-btn {
            background: var(--green);
            color: white;
            padding: 8px 14px;
            border-radius: 24px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .order-btn:hover {
            background: var(--accent);
        }
        /* Dropdown */
        .dropdown {
            position: relative;
        }
        .dropdown-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #333;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .dropdown-menu a {
            display: block;
            padding: 10px 16px;
            text-decoration: none;
            color: #333;
            white-space: nowrap;
        }
        .dropdown-menu a:hover {
            background: #f4f4f4;
        }
        .wrap{max-width:1100px;margin:24px auto;padding:0 6%; width: 100%;}
        .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:24px}
        @media(max-width:980px){
            .grid{grid-template-columns:1fr}
        }
        .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:18px;width: 100%;}
        h1{margin:0 0 14px;color:var(--green)}
        .row{display:flex;justify-content:space-between;margin:6px 0}
        .total{font-weight:900;font-size:20px}
        .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--green);color:#fff;font-weight:700;font-size:12px}
        .pay-methods{display:grid;gap:10px;margin-bottom:15px}
        .pm{display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;cursor:pointer;transition:all 0.2s ease}
        .pm:hover, .pm.selected {
            border-color: var(--green);
            box-shadow: 0 0 0 2px rgba(33, 136, 56, 0.2);
        }
        /* Hides the default radio button */
        .pm input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            position: absolute;
            left: -9999px;
        }
        .fields-container{
            display:grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out;
            overflow: hidden;
        }
        .fields-container.active{
            grid-template-rows: 1fr;
        }
        .fields{
            min-height: 0; /* Ensures content doesn't affect grid-template-rows */
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:10px;
            padding-top:10px;
        }
        .fields .full{grid-column:1 / -1; position: relative;}
        .card-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(2px);
            font-size: 1.2rem;
            color: #ccc;
            transition: color 0.3s ease;
        }
        .card-icon.valid {
            color: var(--green);
        }
        label{font-size:12px;color:#475569;font-weight:700;margin:4px 0 6px;display:block}
        input{width:100%;padding:11px;border:1px solid #e5e7eb;border-radius:10px; padding-right: 40px;}
        .btn{display:inline-flex;gap:10px;align-items:center;border:none;border-radius:12px;padding:12px 16px;font-weight:800;background:var(--green);color:#fff;cursor:pointer;transition:background-color 0.3s ease, opacity 0.3s ease}
        .btn:hover{background:var(--accent)}
        .btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .muted{color:#64748b;font-size:13px}
        .summaryBox{border:1px solid #eef2ef;border-radius:12px;padding:12px}
        .loading-spinner {
            display: none;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<nav class="navbar">
    <a href="/" class="brand-logo">
        <video src="../static/images/spice jar (1).mp4" autoplay muted loop playsinline style="width: 50px; height: auto;"></video>
        <span>SpiceJar</span>
    </a>
    <div class="nav-links">
        <a href="/">Home</a>
        <a href="/menu">Menu</a>
        <a href="/about-us">About Us</a>
        <a href="/cart">Cart</a>
        <div class="dropdown">
            <button class="dropdown-toggle">
                <i class="fas fa-user"></i> Account
            </button>
            <div class="dropdown-menu">
                <!-- Not logged in -->
                <a th:if="${session.USER == null}" th:href="@{/login}">Login</a>
                <a th:if="${session.USER == null}" th:href="@{/register}">Register</a>
            </div>
        </div>
    </div>
</nav>

<main class="wrap">
    <h1><i class="fa-solid fa-lock"></i> Secure Payment</h1>
    <div class="grid">
        <!-- LEFT: Payment form -->
        <section class="card">
            <div class="muted" style="margin-bottom:6px">Order <b>#<span th:text="${order.id}">0</span></b></div>
            <div style="margin-bottom:12px">
                <span class="badge" th:text="${order.status != null ? order.status : 'PENDING'}">PENDING</span>
            </div>

            <form th:action="@{/payment/charge}" method="post" id="payForm">
                <input type="hidden" name="paymentId" th:value="${payment.id}"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="pay-methods">
                    <label class="pm selected"><input type="radio" name="method" value="CARD" checked> <i class="fa-regular fa-credit-card"></i> Credit / Debit Card</label>
                    <label class="pm"><input type="radio" name="method" value="PAYPAL"> <i class="fab fa-paypal"></i> PayPal</label>
                </div>

                <!-- Card fields -->
                <div id="cardFields" class="fields-container active">
                    <div class="fields">
                        <div class="full">
                            <label>Card Number</label>
                            <input name="cardNumber" id="cardNumberInput" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatAndIdentifyCard(this)"/>
                            <i id="card-type-icon" class="fa-regular fa-credit-card card-icon"></i>
                        </div>
                        <div>
                            <label>Expiry (MM/YY)</label>
                            <input name="cardExpiry" placeholder="MM/YY" maxlength="5" oninput="formatExp(this)"/>
                        </div>
                        <div>
                            <label>CVV</label>
                            <input name="cardCvv" placeholder="123" maxlength="4" type="password"/>
                        </div>
                        <div class="full">
                            <label>Name on Card</label>
                            <input name="cardName" placeholder="Name as on card"/>
                        </div>
                    </div>
                </div>

                <!-- PayPal field -->
                <div id="paypalField" class="fields-container">
                    <div class="fields">
                        <div class="full">
                            <label>PayPal Email</label>
                            <input name="paypalEmail" placeholder="you@example.com"/>
                        </div>
                    </div>
                </div>

                <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center">
                    <span class="muted"><i class="fa-solid fa-shield-halved"></i> Payments are encrypted & secure</span>
                    <button class="btn" type="submit" id="payButton">
                        <i class="fa-solid fa-credit-card"></i>
                        <span class="btn-text">Pay <span th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span></span>
                        <div class="loading-spinner"></div>
                    </button>
                </div>
            </form>
        </section>

        <!-- RIGHT: Summary -->
        <aside class="card">
            <h3 style="margin:0 0 10px">Order Summary</h3>
            <div class="summaryBox">
                <div class="row"><span>Items</span><span th:text="${#lists.size(order.items)}">0</span></div>
                <div class="row"><span>Subtotal</span><span th:text="${#numbers.formatDecimal(order.subtotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
                <div class="row"><span>Tax (8%)</span><span th:text="${#numbers.formatDecimal(order.tax,1,'COMMA',2,'POINT')}">$0.00</span></div>
                <div class="row total"><span>Total</span><span th:text="${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">$0.00</span></div>
            </div>

            <h4 style="margin:14px 0 8px">Items</h4>
            <div class="summaryBox" style="max-height:220px;overflow:auto">
                <div th:each="it : ${order.items}" style="display:flex;justify-content:space-between;margin:6px 0">
                    <div>
                        <b th:text="${it.productName}">Item</b>
                        <div class="muted">Ã— <span th:text="${it.quantity}">1</span></div>
                    </div>
                    <div>
                        <span th:text="${#numbers.formatDecimal(it.price,1,'COMMA',2,'POINT')}">$0.00</span>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const paymentMethods = document.querySelectorAll('input[name="method"]');
        const cardFields = document.getElementById('cardFields');
        const paypalField = document.getElementById('paypalField');
        const payForm = document.getElementById('payForm');
        const payButton = document.getElementById('payButton');
        const btnText = payButton.querySelector('.btn-text');
        const loadingSpinner = payButton.querySelector('.loading-spinner');
        const cardTypeIcon = document.getElementById('card-type-icon');

        const cardTypes = [
            { pattern: /^4/, icon: 'fa-cc-visa' },
            { pattern: /^(5[1-5]|222[1-9]|22[3-9]|2[3-6]|27[0-1]|2720)/, icon: 'fa-cc-mastercard' },
            { pattern: /^3[47]/, icon: 'fa-cc-amex' },
            { pattern: /^3(?:0[0-5]|[68][0-9])/, icon: 'fa-cc-diners-club' },
            { pattern: /^6(?:011|5[0-9]{2})/, icon: 'fa-cc-discover' },
            { pattern: /^(?:2131|1800|35\d{3})/, icon: 'fa-cc-jcb' }
        ];

        function getCardType(number) {
            for (let i = 0; i < cardTypes.length; i++) {
                if (number.match(cardTypes[i].pattern)) {
                    return cardTypes[i].icon;
                }
            }
            return 'fa-credit-card';
        }

        paymentMethods.forEach(r => {
            r.addEventListener('change', () => {
                // Remove selected class from all labels
                document.querySelectorAll('.pm').forEach(label => label.classList.remove('selected'));
                // Add selected class to the changed label's parent
                r.parentElement.classList.add('selected');

                const value = r.value;
                cardFields.classList.toggle('active', value === 'CARD');
                paypalField.classList.toggle('active', value === 'PAYPAL');

                // Update button text and icon based on selection
                let newText, newIcon;
                switch(value) {
                    case 'CARD':
                        newText = 'Pay';
                        newIcon = 'fa-credit-card';
                        break;
                    case 'PAYPAL':
                        newText = 'Pay with PayPal';
                        newIcon = 'fa-paypal';
                        break;
                }
                payButton.querySelector('i').className = `fa-solid ${newIcon}`;
                btnText.innerHTML = `${newText} <span th:text="\${#numbers.formatDecimal(order.grandTotal,1,'COMMA',2,'POINT')}">\${order.grandTotal}</span>`;
            });
        });

        payForm.addEventListener('submit', () => {
            payButton.classList.add('loading');
            payButton.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'block';
        });

        function formatAndIdentifyCard(el) {
            const cleanValue = el.value.replace(/\D/g, '');
            const cardIcon = document.getElementById('card-type-icon');
            const cardType = getCardType(cleanValue);

            cardIcon.className = `fa-brands ${cardType} card-icon`;

            // Basic validation for icon color change
            if (cleanValue.length >= 12 && cleanValue.length <= 19) {
                cardIcon.classList.add('valid');
            } else {
                cardIcon.classList.remove('valid');
            }

            // Format the card number for display
            el.value = cleanValue.replace(/(.{4})/g, '$1 ').trim();
        }

        function formatExp(el){
            el.value = el.value.replace(/\D/g,'').slice(0,4).replace(/^(\d{0,2})(\d{0,2}).*/,'$1' + (el.value.length>2?'/':'') + '$2');
        }

        window.formatAndIdentifyCard = formatAndIdentifyCard;
        window.formatExp = formatExp;
    });
</script>
</body>
</html>
